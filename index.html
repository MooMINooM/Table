<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nonsawan Games 2025 (V.40 Full Scale)</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    :root { 
        --header-h: 60px; --sidebar-w: 240px;
        --primary: #1e40af; --bg: #f8fafc; --text: #0f172a; --white: #ffffff;
        --border: #e2e8f0;
        --c-fb: #3b82f6; --c-vb: #f97316; --c-tk: #10b981; --c-pt: #8b5cf6;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* Header */
    .app-header { height: var(--header-h); background: var(--white); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .brand { font-size: 1.25rem; font-weight: 800; color: var(--primary); display: flex; gap: 10px; align-items: center; cursor: pointer; }
    .day-tabs { display: flex; gap: 5px; background: #f1f5f9; padding: 4px; border-radius: 8px; }
    .day-btn { border: none; background: transparent; padding: 6px 14px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; color: #64748b; font-weight: 600; transition: 0.2s; }
    .day-btn:hover { background: #e2e8f0; color: #334155; }
    .day-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .actions button { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--white); cursor: pointer; color: #64748b; margin-left: 5px; transition: 0.2s; }
    .actions button:hover { background: #eff6ff; color: var(--primary); border-color: var(--primary); }

    /* Layout */
    .main-layout { flex: 1; display: flex; overflow: hidden; }
    
    /* Sidebar */
    .sidebar { width: var(--sidebar-w); background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; }
    .sb-group { padding: 15px; border-bottom: 1px solid var(--border); }
    .sb-title { font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; color: #475569; font-weight: 500; margin-bottom: 2px; transition: 0.2s; }
    .nav-item:hover { background: #f1f5f9; color: var(--primary); }
    .nav-item.active { background: #eff6ff; color: var(--primary); font-weight: 700; }
    .nav-icon { width: 24px; text-align: center; }

    /* Content */
    .content { flex: 1; padding: 20px; overflow-y: auto; background: #f8fafc; }
    .schedule-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 1200px) { .schedule-grid { grid-template-columns: 1fr 1fr; } }

    .time-card { background: var(--white); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); break-inside: avoid; margin-bottom: 20px; }
    .time-head { background: #f1f5f9; padding: 8px 15px; border-bottom: 1px solid var(--border); font-weight: 700; color: #334155; display: flex; align-items: center; gap: 8px; }
    
    .match-row { display: flex; padding: 12px 15px; border-bottom: 1px solid var(--border); position: relative; gap: 12px; align-items: center; }
    .match-row:last-child { border-bottom: none; }
    .match-row::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .b-FB::before { background: var(--c-fb); } .b-VB::before { background: var(--c-vb); }
    .b-TK::before { background: var(--c-tk); } .b-PT::before { background: var(--c-pt); }

    .m-left { display: flex; flex-direction: column; gap: 4px; min-width: 100px; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; color: white; width: fit-content; }
    .bg-FB { background: var(--c-fb); } .bg-VB { background: var(--c-vb); } .bg-TK { background: var(--c-tk); } .bg-PT { background: var(--c-pt); }
    
    .m-center { flex: 1; }
    .versus { display: flex; align-items: center; justify-content: space-between; font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
    .score-inp { width: 32px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: 700; color: var(--primary); background: #f8fafc; }
    .field-ref { font-size: 0.75rem; color: #64748b; display: flex; gap: 10px; align-items: center; }
    .ref-badge { background: #e2e8f0; color: #475569; padding: 1px 6px; border-radius: 10px; font-size: 0.7rem; }

    /* Right Panel (Standings) */
    .right-panel { width: 380px; background: var(--white); border-left: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
    .rp-head { padding: 15px; font-weight: 700; border-bottom: 1px solid var(--border); background: #f8fafc; }
    .st-container { padding: 15px; display: flex; flex-direction: column; gap: 20px; }
    .st-card { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .st-title { background: #f1f5f9; padding: 8px 12px; font-size: 0.85rem; font-weight: 700; color: #475569; border-bottom: 1px solid var(--border); }
    .st-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .st-table th, .st-table td { padding: 6px 8px; text-align: center; border-bottom: 1px solid #f1f5f9; }
    .st-table td:nth-child(2) { text-align: left; }
    .hl-pts { background: #eff6ff; color: var(--primary); font-weight: 700; }

    .winner-bracket { padding: 10px; font-size: 0.85rem; }
    .bracket-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #e2e8f0; }

    #toast { visibility: hidden; min-width: 200px; background-color: #0f172a; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; opacity: 0; transition: opacity 0.3s; }
    #toast.show { visibility: visible; opacity: 1; }
    
    @media (max-width: 1024px) { .right-panel { display: none; } }
</style>
</head>
<body>

<header class="app-header">
    <div class="brand" onclick="location.reload()"><i class="fas fa-medal"></i> Nonsawan Games 2025</div>
    <div class="day-tabs">
        <button class="day-btn active" onclick="setDay(1)">16 ธ.ค. (บ่าย)</button>
        <button class="day-btn" onclick="setDay(2)">17 ธ.ค. (บ่าย)</button>
        <button class="day-btn" onclick="setDay(3)">18 ธ.ค. (เต็ม)</button>
        <button class="day-btn" onclick="setDay(4)">19 ธ.ค. (เต็ม)</button>
    </div>
    <div class="actions">
        <button title="บันทึกผล" onclick="saveToLocal()"><i class="fas fa-save"></i></button>
        <button title="รีเซ็ตตาราง" onclick="resetSystem()"><i class="fas fa-sync-alt"></i></button>
    </div>
</header>

<div class="main-layout">
    <aside class="sidebar">
        <div class="sb-group">
            <div class="sb-title">เลือกกีฬา (20 รายการ)</div>
            <div class="nav-item active" onclick="filterSport('ALL')"><div class="nav-icon"><i class="fas fa-th-large"></i></div> ทั้งหมด</div>
            <div class="nav-item" onclick="filterSport('FB')"><div class="nav-icon" style="color:var(--c-fb)"><i class="fas fa-futbol"></i></div> ฟุตบอล</div>
            <div class="nav-item" onclick="filterSport('VB')"><div class="nav-icon" style="color:var(--c-vb)"><i class="fas fa-volleyball-ball"></i></div> วอลเลย์บอล</div>
            <div class="nav-item" onclick="filterSport('TK')"><div class="nav-icon" style="color:var(--c-tk)"><i class="fas fa-baseball-ball"></i></div> เซปักตะกร้อ</div>
            <div class="nav-item" onclick="filterSport('PT')"><div class="nav-icon" style="color:var(--c-pt)"><i class="fas fa-bowling-ball"></i></div> เปตอง</div>
        </div>
    </aside>

    <main class="content" id="mainContent">
        </main>

    <aside class="right-panel">
        <div class="rp-head"><i class="fas fa-chart-line"></i> ผลการแข่งขัน & ตารางคะแนน</div>
        <div class="st-container" id="standingsContent">
            </div>
    </aside>
</div>

<div id="toast">บันทึกข้อมูลเรียบร้อย</div>

<script>
/** * SYSTEM CONFIGURATION (V.40)
 */

// 1. Schools Data
const schools = [
    { id: 'S1', name: "โนนสวรรค์ฯ", type: 'PRI' }, { id: 'S2', name: "ท่าอุทัย", type: 'PRI' },
    { id: 'S3', name: "ภูพระฯ", type: 'PRI' }, { id: 'S4', name: "โนนม่วง", type: 'PRI' },
    { id: 'S5', name: "โนนสวาทฯ", type: 'PRI' }, { id: 'S6', name: "หนองกุงศรีฯ", type: 'PRI' },
    { id: 'S7', name: "โนนไหมฯ", type: 'PRI' }, { id: 'S8', name: "ด้วงฯ-ชำฯ", type: 'PRI' },
    { id: 'S9', name: "โนนเมือง", type: 'PRI' },
    // Secondary Schools (Subset or separate, based on prompt context, assuming specific 4)
    { id: 'M1', name: "หนองกุงศรีฯ (ม)", type: 'SEC' }, { id: 'M2', name: "ภูพระฯ (ม)", type: 'SEC' },
    { id: 'M3', name: "โนนม่วง (ม)", type: 'SEC' }, { id: 'M4', name: "โนนเมือง (ม)", type: 'SEC' }
];

// 2. Categories (20 Items)
const categories = [
    // Football
    { id: 'FB_K_M', sp: 'FB', name: 'บอลอนุบาล ชาย', dur: 30, field: 'สนามอนุบาล', lv: 'K', gd: 'M', format: 'group' },
    { id: 'FB_K_F', sp: 'FB', name: 'บอลอนุบาล หญิง', dur: 30, field: 'สนามอนุบาล', lv: 'K', gd: 'F', format: 'group' },
    { id: 'FB_P13_M', sp: 'FB', name: 'บอล ป.ต้น ชาย', dur: 45, field: 'สนาม ป.ต้น', lv: 'P13', gd: 'M', format: 'group' },
    { id: 'FB_P13_F', sp: 'FB', name: 'บอล ป.ต้น หญิง', dur: 45, field: 'สนาม ป.ต้น', lv: 'P13', gd: 'F', format: 'group' },
    { id: 'FB_P46_M', sp: 'FB', name: 'บอล ป.ปลาย ชาย', dur: 60, field: 'สนาม ป.ปลาย', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'FB_P46_F', sp: 'FB', name: 'บอล ป.ปลาย หญิง', dur: 60, field: 'สนาม ป.ปลาย', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'FB_SEC_M', sp: 'FB', name: 'บอล มัธยม ชาย', dur: 60, field: 'สนาม มัธยม', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'FB_SEC_F', sp: 'FB', name: 'บอล มัธยม หญิง', dur: 60, field: 'สนาม มัธยม', lv: 'SEC', gd: 'F', format: 'league' },
    // Volleyball
    { id: 'VB_P46_M', sp: 'VB', name: 'วอลเลย์ ป.ปลาย ชาย', dur: 60, field: 'วอลเลย์ 1 (ป.ปลาย)', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'VB_P46_F', sp: 'VB', name: 'วอลเลย์ ป.ปลาย หญิง', dur: 60, field: 'วอลเลย์ 1 (ป.ปลาย)', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'VB_SEC_M', sp: 'VB', name: 'วอลเลย์ มัธยม ชาย', dur: 60, field: 'วอลเลย์ 2 (มัธยม)', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'VB_SEC_F', sp: 'VB', name: 'วอลเลย์ มัธยม หญิง', dur: 60, field: 'วอลเลย์ 2 (มัธยม)', lv: 'SEC', gd: 'F', format: 'league' },
    // Takraw (Bottleneck: 1 Court)
    { id: 'TK_P46_M', sp: 'TK', name: 'ตะกร้อ ป.ปลาย ชาย', dur: 45, field: 'สนามตะกร้อ (รวม)', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'TK_P46_F', sp: 'TK', name: 'ตะกร้อ ป.ปลาย หญิง', dur: 45, field: 'สนามตะกร้อ (รวม)', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'TK_SEC_M', sp: 'TK', name: 'ตะกร้อ มัธยม ชาย', dur: 45, field: 'สนามตะกร้อ (รวม)', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'TK_SEC_F', sp: 'TK', name: 'ตะกร้อ มัธยม หญิง', dur: 45, field: 'สนามตะกร้อ (รวม)', lv: 'SEC', gd: 'F', format: 'league' },
    // Petanque
    { id: 'PT_P46_M', sp: 'PT', name: 'เปตอง ป.ปลาย ชาย', dur: 60, field: 'เปตอง 1 (ป.ปลาย)', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'PT_P46_F', sp: 'PT', name: 'เปตอง ป.ปลาย หญิง', dur: 60, field: 'เปตอง 1 (ป.ปลาย)', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'PT_SEC_M', sp: 'PT', name: 'เปตอง มัธยม ชาย', dur: 60, field: 'เปตอง 2 (มัธยม)', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'PT_SEC_F', sp: 'PT', name: 'เปตอง มัธยม หญิง', dur: 60, field: 'เปตอง 2 (มัธยม)', lv: 'SEC', gd: 'F', format: 'league' }
];

// 3. Time Slots
const days = [
    { d:1, start: 780, end: 990, label: 'วันที่ 1 (บ่าย 13.00-16.30)' },
    { d:2, start: 780, end: 990, label: 'วันที่ 2 (บ่าย 13.00-16.30)' },
    { d:3, start: 510, end: 990, label: 'วันที่ 3 (เต็ม 08.30-16.30)' },
    { d:4, start: 510, end: 990, label: 'วันที่ 4 (เต็ม 08.30-16.30)' }
];

// Global State
let scheduleData = [];
let currentDay = 1;
let currentFilter = 'ALL';

/**
 * CORE LOGIC: SCHEDULER ENGINE
 */
function generateSchedule() {
    let matches = [];
    let priSchools = schools.filter(s => s.type === 'PRI');
    let secSchools = schools.filter(s => s.type === 'SEC');

    // Step 1: Generate All Matches (Unscheduled)
    categories.forEach(cat => {
        let teams = (cat.lv === 'SEC') ? secSchools : priSchools;
        
        if (cat.format === 'group') {
            // Shuffle & Split into A, B, C
            let shuffled = [...teams].sort(() => 0.5 - Math.random());
            let groups = { 'A': shuffled.slice(0,3), 'B': shuffled.slice(3,6), 'C': shuffled.slice(6,9) };
            
            // Group Stage (Round Robin)
            ['A','B','C'].forEach(gName => {
                let gTeams = groups[gName];
                gTeams.forEach((t1, i) => {
                    for(let j=i+1; j<gTeams.length; j++) {
                        matches.push({
                            uid: `${cat.id}_${matches.length}`,
                            cat: cat,
                            round: `รอบแรก สาย ${gName}`,
                            t1: t1, t2: gTeams[j],
                            stage: 'GROUP', group: gName,
                            priority: 1 // High priority to clear groups first
                        });
                    }
                });
            });

            // Knockout placeholders (Semis & Finals)
            matches.push({ uid: `${cat.id}_SF1`, cat:cat, round:'รอบรองฯ 1', t1:{name:'ที่ 1 สาย A', id:'W_A'}, t2:{name:'ที่ดีสุด', id:'BEST_2'}, stage:'SEMI', priority: 2 });
            matches.push({ uid: `${cat.id}_SF2`, cat:cat, round:'รอบรองฯ 2', t1:{name:'ที่ 1 สาย B', id:'W_B'}, t2:{name:'ที่ 1 สาย C', id:'W_C'}, stage:'SEMI', priority: 2 });
            matches.push({ uid: `${cat.id}_3RD`, cat:cat, round:'ชิงที่ 3', t1:{name:'แพ้รอง 1', id:'L_SF1'}, t2:{name:'แพ้รอง 2', id:'L_SF2'}, stage:'FINAL', priority: 3 });
            matches.push({ uid: `${cat.id}_FN`, cat:cat, round:'ชิงชนะเลิศ', t1:{name:'ชนะรอง 1', id:'W_SF1'}, t2:{name:'ชนะรอง 2', id:'W_SF2'}, stage:'FINAL', priority: 3 });

        } else {
            // League (4 Teams)
            teams.forEach((t1, i) => {
                for(let j=i+1; j<teams.length; j++) {
                    matches.push({
                        uid: `${cat.id}_${matches.length}`,
                        cat: cat,
                        round: 'รอบพบกันหมด',
                        t1: t1, t2: teams[j],
                        stage: 'LEAGUE',
                        priority: 1
                    });
                }
            });
            // Finals
            matches.push({ uid: `${cat.id}_3RD`, cat:cat, round:'ชิงที่ 3', t1:{name:'อันดับ 3', id:'R3'}, t2:{name:'อันดับ 4', id:'R4'}, stage:'FINAL', priority: 2 });
            matches.push({ uid: `${cat.id}_FN`, cat:cat, round:'ชิงชนะเลิศ', t1:{name:'อันดับ 1', id:'R1'}, t2:{name:'อันดับ 2', id:'R2'}, stage:'FINAL', priority: 2 });
        }
    });

    // Step 2: Scheduling Loop (Greedy with Constraints)
    // Sort matches: Priority 1 (Groups) -> Takraw (Limited Resource) -> Others
    matches.sort((a,b) => {
        if(a.priority !== b.priority) return a.priority - b.priority;
        if(a.cat.sp === 'TK' && b.cat.sp !== 'TK') return -1; // Prioritize Takraw to fill the bottleneck
        return 0;
    });

    let scheduled = [];
    let fieldBusyUntil = {}; // { 'FieldID_Day': timestamp }
    let athleteBusyUntil = {}; // { 'SchoolID_Level_Gender_Day': timestamp } -> Constraint A

    // Iterate Days & Time
    let queue = [...matches];
    
    // Helper: Find Referee
    const getReferee = (day, time, cat, team1, team2) => {
        if(cat.lv === 'K') return "กรรมการกลาง"; // Kindergarten shared
        
        let candidates = (cat.lv === 'SEC') ? secSchools : priSchools;
        // Filter out playing teams
        candidates = candidates.filter(s => s.id !== team1.id && s.id !== team2.id);
        
        // Filter out teams whose coach is busy (Playing same Level+Gender at this time)
        // Note: Coach is busy if their team is playing.
        let validRef = candidates.find(s => {
            let busyKey = `${s.id}_${cat.lv}_${cat.gd}_${day}`;
            let busyTime = athleteBusyUntil[busyKey] || 0;
            return busyTime <= time;
        });

        return validRef ? `ครู ${validRef.name}` : "กรรมการกลาง";
    };

    days.forEach(dayConf => {
        let nextQueue = [];
        
        // Reset field availability for new day start
        categories.forEach(c => {
             if(!fieldBusyUntil[`${c.field}_${dayConf.d}`]) fieldBusyUntil[`${c.field}_${dayConf.d}`] = dayConf.start;
        });

        queue.forEach(m => {
            // Kindergarten Time Constraint (Must finish before 15:30)
            let maxTime = (m.cat.lv === 'K') ? 930 : dayConf.end; // 930 = 15:30

            // 1. Check Field Avail
            let fieldKey = `${m.cat.field}_${dayConf.d}`;
            let fieldStart = fieldBusyUntil[fieldKey];
            
            // 2. Check Athlete Avail (Team 1 & 2)
            // Key: SchoolID + Level + Gender (e.g., S1_P46_M)
            let t1Key = m.t1.id.length > 3 ? null : `${m.t1.id}_${m.cat.lv}_${m.cat.gd}_${dayConf.d}`;
            let t2Key = m.t2.id.length > 3 ? null : `${m.t2.id}_${m.cat.lv}_${m.cat.gd}_${dayConf.d}`;
            
            let t1Start = t1Key ? (athleteBusyUntil[t1Key] || dayConf.start) : dayConf.start;
            let t2Start = t2Key ? (athleteBusyUntil[t2Key] || dayConf.start) : dayConf.start;

            // 3. Determine Start Time (Max of all constraints)
            let startTime = Math.max(fieldStart, t1Start, t2Start);
            let endTime = startTime + m.cat.dur;

            // 4. Validate Time
            if (endTime <= maxTime) {
                // Success! Schedule it.
                // Find Referee
                let ref = getReferee(dayConf.d, startTime, m.cat, m.t1, m.t2);

                scheduled.push({
                    ...m,
                    day: dayConf.d,
                    timeStart: startTime,
                    timeEnd: endTime,
                    s1: '', s2: '',
                    referee: ref
                });

                // Update Constraints
                fieldBusyUntil[fieldKey] = endTime;
                
                // REST PERIOD: Athletes must rest 1 match duration (approx 45-60 mins)
                // We add gap equal to match duration
                let gap = m.cat.dur; 
                if(t1Key) athleteBusyUntil[t1Key] = endTime + gap;
                if(t2Key) athleteBusyUntil[t2Key] = endTime + gap;

            } else {
                // No time left today, push to next day
                nextQueue.push(m);
            }
        });
        queue = nextQueue;
    });

    return scheduled;
}

/**
 * UI & UTILITIES
 */
function setDay(d) {
    currentDay = d;
    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderSchedule();
}

function filterSport(sp) {
    currentFilter = sp;
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderSchedule();
    renderStandings();
}

function formatTime(min) {
    let h = Math.floor(min / 60);
    let m = min % 60;
    return `${h.toString().padStart(2,'0')}.${m.toString().padStart(2,'0')}`;
}

function renderSchedule() {
    const container = document.getElementById('mainContent');
    container.innerHTML = '';

    let list = scheduleData.filter(m => m.day === currentDay);
    if(currentFilter !== 'ALL') list = list.filter(m => m.cat.sp === currentFilter);
    list.sort((a,b) => a.timeStart - b.timeStart);

    if(list.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">ไม่มีการแข่งขันในวันนี้</div>`;
        return;
    }

    // Group by time for visual consistency
    let timeSlots = [...new Set(list.map(m => m.timeStart))].sort((a,b)=>a-b);

    timeSlots.forEach(t => {
        let items = list.filter(m => m.timeStart === t);
        let card = document.createElement('div');
        card.className = 'time-card';
        
        let rows = items.map(m => {
            let badgeClass = `bg-${m.cat.sp}`;
            return `
            <div class="match-row b-${m.cat.sp}">
                <div class="m-left">
                    <span class="badge ${badgeClass}">${m.cat.sp}</span>
                    <span style="font-size:0.75rem; color:#64748b; font-weight:600;">${m.cat.lv} ${m.cat.gd}</span>
                </div>
                <div class="m-center">
                    <div class="versus">
                        <span>${m.t1.name}</span>
                        <div style="display:flex; gap:5px;">
                            <input type="text" class="score-inp" value="${m.s1}" onchange="updateScore('${m.uid}', 1, this.value)">
                            <span style="color:#94a3b8">:</span>
                            <input type="text" class="score-inp" value="${m.s2}" onchange="updateScore('${m.uid}', 2, this.value)">
                        </div>
                        <span>${m.t2.name}</span>
                    </div>
                    <div class="field-ref">
                        <span><i class="fas fa-map-marker-alt"></i> ${m.cat.field}</span>
                        <span>|</span>
                        <span>${m.round}</span>
                        <span class="ref-badge"><i class="fas fa-whistle"></i> ${m.referee}</span>
                    </div>
                </div>
            </div>`;
        }).join('');

        card.innerHTML = `<div class="time-head"><i class="far fa-clock"></i> ${formatTime(t)} - ${formatTime(items[0].timeEnd)} น.</div>${rows}`;
        container.appendChild(card);
    });
}

function renderStandings() {
    const container = document.getElementById('standingsContent');
    container.innerHTML = '';
    
    // If ALL, show summary text
    if(currentFilter === 'ALL') {
        container.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;">เลือกชนิดกีฬาด้านซ้าย<br>เพื่อดูตารางคะแนน</div>`;
        return;
    }

    // Filter categories by current sport
    let sportCats = categories.filter(c => c.sp === currentFilter);
    
    sportCats.forEach(cat => {
        // Calculate Standings based on matches in scheduleData
        let matches = scheduleData.filter(m => m.cat.id === cat.id && m.stage === 'GROUP' && m.s1 !== '' && m.s2 !== '');
        let teams = {};
        
        // Init stats
        matches.forEach(m => {
            if(!teams[m.t1.name]) teams[m.t1.name] = { P:0, W:0, D:0, L:0, PTS:0, G:m.group };
            if(!teams[m.t2.name]) teams[m.t2.name] = { P:0, W:0, D:0, L:0, PTS:0, G:m.group };
            
            let s1 = parseInt(m.s1), s2 = parseInt(m.s2);
            teams[m.t1.name].P++; teams[m.t2.name].P++;
            
            if(s1 > s2) { teams[m.t1.name].W++; teams[m.t1.name].PTS+=3; teams[m.t2.name].L++; }
            else if(s2 > s1) { teams[m.t2.name].W++; teams[m.t2.name].PTS+=3; teams[m.t1.name].L++; }
            else { teams[m.t1.name].D++; teams[m.t1.name].PTS+=1; teams[m.t2.name].D++; teams[m.t2.name].PTS+=1; }
        });

        // Determine State: Group/League or Knockout
        // Check if Finals exist
        let finals = scheduleData.filter(m => m.cat.id === cat.id && m.stage === 'FINAL');
        let semis = scheduleData.filter(m => m.cat.id === cat.id && m.stage === 'SEMI');
        
        let card = document.createElement('div');
        card.className = 'st-card';
        
        let headerHtml = `<div class="st-title">${cat.name}</div>`;
        let bodyHtml = '';

        // Logic: Show Table first. If Knockout matches have scores, show Bracket.
        if (cat.format === 'group') {
             // Show Group Tables A, B, C
             ['A','B','C'].forEach(g => {
                 let gTeams = Object.keys(teams).filter(k => teams[k].G === g).sort((a,b) => teams[b].PTS - teams[a].PTS);
                 if(gTeams.length > 0) {
                     bodyHtml += `<div style="background:#f8fafc; padding:4px 8px; font-size:0.75rem; font-weight:700;">สาย ${g}</div>`;
                     bodyHtml += `<table class="st-table"><tr><th>#</th><th>ทีม</th><th>P</th><th>Pts</th></tr>`;
                     gTeams.forEach((t, i) => {
                         bodyHtml += `<tr><td>${i+1}</td><td>${t}</td><td>${teams[t].P}</td><td class="hl-pts">${teams[t].PTS}</td></tr>`;
                     });
                     bodyHtml += `</table>`;
                 }
             });
        } else {
             // League Table
             let lTeams = Object.keys(teams).sort((a,b) => teams[b].PTS - teams[a].PTS);
             if(lTeams.length > 0) {
                 bodyHtml += `<table class="st-table"><tr><th>#</th><th>ทีม</th><th>P</th><th>Pts</th></tr>`;
                 lTeams.forEach((t, i) => {
                     bodyHtml += `<tr><td>${i+1}</td><td>${t}</td><td>${teams[t].P}</td><td class="hl-pts">${teams[t].PTS}</td></tr>`;
                 });
                 bodyHtml += `</table>`;
             }
        }

        // Add Knockout Results if available
        let koMatches = [...semis, ...finals].filter(m => m.s1 !== '' && m.s2 !== '');
        if(koMatches.length > 0) {
            bodyHtml += `<div style="padding:10px; border-top:1px solid #e2e8f0;">`;
            bodyHtml += `<div style="font-size:0.75rem; font-weight:700; margin-bottom:5px;">ผลรอบน็อคเอาท์</div>`;
            koMatches.forEach(m => {
                let w = parseInt(m.s1) > parseInt(m.s2) ? m.t1.name : m.t2.name;
                bodyHtml += `<div class="bracket-row"><span>${m.round}</span> <span style="font-weight:700; color:var(--primary)">${w} ชนะ</span></div>`;
            });
            bodyHtml += `</div>`;
        } else if (scheduleData.some(m => m.cat.id === cat.id && m.stage === 'SEMI')) {
            // Show placeholder bracket
            bodyHtml += `<div class="winner-bracket text-center text-gray-400">รอผลรอบแบ่งกลุ่ม...</div>`;
        }

        card.innerHTML = headerHtml + bodyHtml;
        container.appendChild(card);
    });
}

// Data Persistence
function updateScore(uid, slot, val) {
    let m = scheduleData.find(x => x.uid === uid);
    if(m) {
        if(slot === 1) m.s1 = val; else m.s2 = val;
        saveToLocal(true); // silent save
        renderStandings(); // Realtime update standings
    }
}

function saveToLocal(silent) {
    localStorage.setItem('ns_games_v40', JSON.stringify(scheduleData));
    if(!silent) {
        let t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }
}

function resetSystem() {
    if(confirm('ระบบจะทำการสุ่มจับสลากและจัดตารางเวลาใหม่ทั้งหมด ข้อมูลคะแนนจะหายไป ยืนยันหรือไม่?')) {
        scheduleData = generateSchedule();
        saveToLocal();
        location.reload();
    }
}

// Init
window.onload = () => {
    let saved = localStorage.getItem('ns_games_v40');
    if(saved) scheduleData = JSON.parse(saved);
    else scheduleData = generateSchedule();
    
    renderSchedule();
    renderStandings();
};

</script>
</body>
</html>
