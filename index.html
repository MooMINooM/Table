<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Å‡∏µ‡∏¨‡∏≤‡∏™‡∏µ - 9 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .school-tag { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; color: white; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg p-6 mb-6">
        <h1 class="text-2xl font-bold text-blue-800 mb-2">üèÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô (‡πÅ‡∏¢‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô)</h1>
        <p class="text-gray-600 text-sm">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: 9 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô | 4 ‡∏ß‡∏±‡∏ô (2 ‡∏ö‡πà‡∏≤‡∏¢ + 2 ‡πÄ‡∏ï‡πá‡∏°) | ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏ô‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏° | ‡∏Å‡∏µ‡∏¨‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏¢‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô</p>
        
        <div class="mt-4 flex gap-4 flex-wrap">
            <button onclick="generateSchedule()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow transition">
                üîÑ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
            <div class="text-sm text-gray-500 self-center">
                *‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏£‡∏π/‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°)
            </div>
        </div>
    </div>

    <div id="outputArea" class="max-w-7xl mx-auto hidden">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-indigo-100 p-4 rounded-lg border-l-4 border-indigo-500">
                <h3 class="font-bold text-indigo-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <p class="text-2xl font-bold" id="totalMatches">0</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg border-l-4 border-green-500">
                <h3 class="font-bold text-green-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <p class="text-xl font-bold" id="lastMatchTime">-</p>
            </div>
            <div class="bg-yellow-100 p-4 rounded-lg border-l-4 border-yellow-500">
                <h3 class="font-bold text-yellow-700">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≠ (‡∏™‡∏ô‡∏≤‡∏°‡∏£‡∏ß‡∏°)</h3>
                <p class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="takrawStatus">‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span></p>
            </div>
        </div>

        <div class="space-y-6" id="scheduleContainer">
            </div>

    </div>

<script>
    // --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô ---
    const schools = [
        { id: 1, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 1", color: "bg-red-500" },
        { id: 2, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 2", color: "bg-blue-500" },
        { id: 3, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 3", color: "bg-green-500" },
        { id: 4, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 4", color: "bg-yellow-500" },
        { id: 5, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 5", color: "bg-purple-500" },
        { id: 6, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 6", color: "bg-pink-500" },
        { id: 7, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 7", color: "bg-orange-500" },
        { id: 8, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 8", color: "bg-teal-500" },
        { id: 9, name: "‡∏£‡∏£.‡∏ö‡πâ‡∏≤‡∏ô 9", color: "bg-gray-600" }
    ];

    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏µ‡∏¨‡∏≤
    const sportsConfig = [
        // ‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• (‡πÅ‡∏¢‡∏Å‡∏™‡∏ô‡∏≤‡∏°)
        { id: 'FB_KINDER', name: '‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• ‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•', field: '‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• 1 (‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•)', duration: 30, type: 'group_9' },
        { id: 'FB_P_LOW', name: '‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• ‡∏õ.‡∏ï‡πâ‡∏ô', field: '‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• 2 (‡∏õ.‡∏ï‡πâ‡∏ô)', duration: 45, type: 'group_9' },
        { id: 'FB_P_HIGH', name: '‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• ‡∏õ.‡∏õ‡∏•‡∏≤‡∏¢', field: '‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• 3 (‡∏õ.‡∏õ‡∏•‡∏≤‡∏¢)', duration: 60, type: 'group_9' },
        { id: 'FB_M_HIGH', name: '‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• ‡∏°‡∏±‡∏ò‡∏¢‡∏°', field: '‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• 4 (‡∏°‡∏±‡∏ò‡∏¢‡∏°)', duration: 60, type: 'round_4' }, // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏°‡∏µ 4 ‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ
        
        // ‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå‡∏ö‡∏≠‡∏• (‡πÅ‡∏¢‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô)
        { id: 'VB_P_HIGH', name: '‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå ‡∏õ.‡∏õ‡∏•‡∏≤‡∏¢', field: '‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå 1 (‡∏õ.‡∏õ‡∏•‡∏≤‡∏¢)', duration: 60, type: 'group_9' },
        { id: 'VB_M_HIGH', name: '‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå ‡∏°‡∏±‡∏ò‡∏¢‡∏°', field: '‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå 2 (‡∏°‡∏±‡∏ò‡∏¢‡∏°)', duration: 60, type: 'round_4' },

        // ‡πÄ‡∏õ‡∏ï‡∏≠‡∏á (‡πÅ‡∏¢‡∏Å‡∏™‡∏ô‡∏≤‡∏°)
        { id: 'PT_P_HIGH', name: '‡πÄ‡∏õ‡∏ï‡∏≠‡∏á ‡∏õ.‡∏õ‡∏•‡∏≤‡∏¢', field: '‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏õ‡∏ï‡∏≠‡∏á 1 (‡∏õ.‡∏õ‡∏•‡∏≤‡∏¢)', duration: 60, type: 'group_9' },
        { id: 'PT_M_HIGH', name: '‡πÄ‡∏õ‡∏ï‡∏≠‡∏á ‡∏°‡∏±‡∏ò‡∏¢‡∏°', field: '‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏õ‡∏ï‡∏≠‡∏á 2 (‡∏°‡∏±‡∏ò‡∏¢‡∏°)', duration: 60, type: 'round_4' },

        // ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≠ (‡∏™‡∏ô‡∏≤‡∏°‡∏£‡∏ß‡∏° - Critical Resource)
        { id: 'TK_P_HIGH', name: '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≠ ‡∏õ.‡∏õ‡∏•‡∏≤‡∏¢', field: '‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≠ (‡∏£‡∏ß‡∏°)', duration: 45, type: 'group_9' },
        { id: 'TK_M_HIGH', name: '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≠ ‡∏°‡∏±‡∏ò‡∏¢‡∏°', field: '‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≠ (‡∏£‡∏ß‡∏°)', duration: 45, type: 'round_4' }
    ];

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Time Slots)
    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1,2: 13.00 (780‡∏ô‡∏≤‡∏ó‡∏µ) - 16.30 (990‡∏ô‡∏≤‡∏ó‡∏µ)
    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3,4: 08.30 (510‡∏ô‡∏≤‡∏ó‡∏µ) - 16.30 (990‡∏ô‡∏≤‡∏ó‡∏µ)
    const daysConfig = [
        { day: 1, name: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 (‡∏ö‡πà‡∏≤‡∏¢)", start: 780, end: 990 },
        { day: 2, name: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 (‡∏ö‡πà‡∏≤‡∏¢)", start: 780, end: 990 },
        { day: 3, name: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)", start: 510, end: 990 },
        { day: 4, name: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 4 (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)", start: 510, end: 990 }
    ];

    let allMatches = [];
    let scheduleResult = [];

    // --- 2. Logic ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå ---
    function generateMatches() {
        allMatches = [];
        
        sportsConfig.forEach(sport => {
            if (sport.type === 'group_9') {
                // 1. ‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏≤‡∏¢ A(3), B(3), C(3)
                let shuffled = [...schools].sort(() => 0.5 - Math.random());
                let groupA = shuffled.slice(0,3);
                let groupB = shuffled.slice(3,6);
                let groupC = shuffled.slice(6,9);

                // ‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å (‡∏û‡∏ö‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏™‡∏≤‡∏¢)
                const createGroupMatches = (group, gName) => {
                    for(let i=0; i<group.length; i++) {
                        for(let j=i+1; j<group.length; j++) {
                            allMatches.push({
                                sport: sport,
                                round: `‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å ‡∏™‡∏≤‡∏¢ ${gName}`,
                                team1: group[i],
                                team2: group[j],
                                priority: 1
                            });
                        }
                    }
                };
                createGroupMatches(groupA, 'A');
                createGroupMatches(groupB, 'B');
                createGroupMatches(groupC, 'C');

                // ‡∏£‡∏≠‡∏ö‡∏ô‡πá‡∏≠‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå (Placeholder)
                // ‡∏£‡∏≠‡∏ö 4 ‡∏ó‡∏µ‡∏° (‡∏ó‡∏µ‡πà 1 A, B, C + ‡∏î‡∏µ‡∏™‡∏∏‡∏î) -> ‡∏ï‡∏±‡∏î‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å -> ‡∏ä‡∏¥‡∏á
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ "‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞..."
                let dummyT1 = { name: "‡∏ó‡∏µ‡πà 1 ‡∏™‡∏≤‡∏¢ A", id: 99 };
                let dummyT2 = { name: "‡∏ó‡∏µ‡πà 1 ‡∏™‡∏≤‡∏¢ B", id: 99 };
                let dummyT3 = { name: "‡∏ó‡∏µ‡πà 1 ‡∏™‡∏≤‡∏¢ C", id: 99 };
                let dummyT4 = { name: "‡∏ó‡∏µ‡πà 2 ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", id: 99 };

                allMatches.push({ sport: sport, round: "‡∏£‡∏≠‡∏ö‡∏£‡∏≠‡∏á‡∏ä‡∏ô‡∏∞‡πÄ‡∏•‡∏¥‡∏® 1", team1: dummyT1, team2: dummyT4, priority: 2 });
                allMatches.push({ sport: sport, round: "‡∏£‡∏≠‡∏ö‡∏£‡∏≠‡∏á‡∏ä‡∏ô‡∏∞‡πÄ‡∏•‡∏¥‡∏® 2", team1: dummyT2, team2: dummyT3, priority: 2 });
                allMatches.push({ sport: sport, round: "‡∏ä‡∏¥‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 3", team1: {name:"‡πÅ‡∏û‡πâ‡∏£‡∏≠‡∏ö‡∏£‡∏≠‡∏á 1"}, team2: {name:"‡πÅ‡∏û‡πâ‡∏£‡∏≠‡∏ö‡∏£‡∏≠‡∏á 2"}, priority: 3 });
                allMatches.push({ sport: sport, round: "‡∏ä‡∏¥‡∏á‡∏ä‡∏ô‡∏∞‡πÄ‡∏•‡∏¥‡∏®", team1: {name:"‡∏ä‡∏ô‡∏∞‡∏£‡∏≠‡∏ö‡∏£‡∏≠‡∏á 1"}, team2: {name:"‡∏ä‡∏ô‡∏∞‡∏£‡∏≠‡∏ö‡∏£‡∏≠‡∏á 2"}, priority: 3 });

            } else if (sport.type === 'round_4') {
                // ‡∏°‡∏±‡∏ò‡∏¢‡∏° 4 ‡∏ó‡∏µ‡∏° (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° 1-4 ‡∏°‡∏≤‡πÅ‡∏Ç‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢‡πÇ‡∏≠‡∏Å‡∏≤‡∏™)
                let mTeams = schools.slice(0, 4); 
                
                // ‡∏û‡∏ö‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î
                for(let i=0; i<mTeams.length; i++) {
                    for(let j=i+1; j<mTeams.length; j++) {
                        allMatches.push({
                            sport: sport,
                            round: `‡∏£‡∏≠‡∏ö‡∏û‡∏ö‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î`,
                            team1: mTeams[i],
                            team2: mTeams[j],
                            priority: 1
                        });
                    }
                }
                // ‡∏ä‡∏¥‡∏á
                allMatches.push({ sport: sport, round: "‡∏ä‡∏¥‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 3", team1: {name:"‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 3"}, team2: {name:"‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 4"}, priority: 2 });
                allMatches.push({ sport: sport, round: "‡∏ä‡∏¥‡∏á‡∏ä‡∏ô‡∏∞‡πÄ‡∏•‡∏¥‡∏®", team1: {name:"‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1"}, team2: {name:"‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2"}, priority: 2 });
            }
        });

        // Sort by priority (Group stage first)
        allMatches.sort((a,b) => a.priority - b.priority);
    }

    // --- 3. Logic ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Scheduler) ---
    function runScheduler() {
        scheduleResult = [];
        // Track field usage time (minutes from start of day) per day
        let fieldCursors = {}; 
        sportsConfig.forEach(s => {
            daysConfig.forEach(d => {
                fieldCursors[`${s.field}_D${d.day}`] = d.start;
            });
        });

        // Track Team Availability to prevent overlap (School X is busy until Time T on Day D)
        let schoolBusyUntil = {}; // Key: "D1_SchoolID", Value: minute

        // Clone matches list to process
        let queue = [...allMatches];
        let processed = [];

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô (1 -> 4)
        for (let d = 0; d < daysConfig.length; d++) {
            let currentDay = daysConfig[d];
            let dayKey = currentDay.day;

            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏¢‡∏±‡∏î‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏•‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            let remainingQueue = [];
            
            for (let m = 0; m < queue.length; m++) {
                let match = queue[m];
                let fieldKey = `${match.sport.field}_D${dayKey}`;
                let currentTime = fieldCursors[fieldKey];
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (currentTime + match.sport.duration > currentDay.end) {
                    remainingQueue.push(match); // ‡∏¢‡∏Å‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    continue;
                }

                // *** CONFLICT CHECK ***
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏°‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ ID ‡∏à‡∏£‡∏¥‡∏á)
                let t1Busy = (match.team1.id) ? (schoolBusyUntil[`D${dayKey}_${match.team1.id}`] || 0) : 0;
                let t2Busy = (match.team2.id) ? (schoolBusyUntil[`D${dayKey}_${match.team2.id}`] || 0) : 0;

                let startTime = Math.max(currentTime, t1Busy, t2Busy);
                let finishTime = startTime + match.sport.duration;

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ß‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏°
                if (finishTime > currentDay.end) {
                    remainingQueue.push(match);
                    continue;
                }

                // ‡∏ú‡πà‡∏≤‡∏ô! ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ
                scheduleResult.push({
                    day: currentDay.name,
                    timeStart: formatTime(startTime),
                    timeEnd: formatTime(finishTime),
                    sport: match.sport.name,
                    field: match.sport.field,
                    match: `${match.team1.name} vs ${match.team2.name}`,
                    round: match.round,
                    color: match.sport.id.includes('TK') ? 'bg-orange-100 border-orange-500' : 'bg-white border-blue-200'
                });

                // Update Cursors
                fieldCursors[fieldKey] = finishTime; // ‡∏™‡∏ô‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ
                if(match.team1.id) schoolBusyUntil[`D${dayKey}_${match.team1.id}`] = finishTime + 10; // ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á + ‡∏û‡∏±‡∏Å 10 ‡∏ô‡∏≤‡∏ó‡∏µ
                if(match.team2.id) schoolBusyUntil[`D${dayKey}_${match.team2.id}`] = finishTime + 10;

                // Update processed list (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏Å‡∏•‡∏±‡∏ö queue)
            }
            queue = remainingQueue; // ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏¢‡∏Å‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        }

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (queue.length > 0) {
            alert(`‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏°‡∏µ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô ${queue.length} ‡∏Ñ‡∏π‡πà ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≠‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)`);
        }
    }

    function formatTime(minutes) {
        let h = Math.floor(minutes / 60);
        let m = minutes % 60;
        return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
    }

    // --- 4. Render UI ---
    function renderSchedule() {
        const container = document.getElementById('scheduleContainer');
        container.innerHTML = '';

        // Group by Day
        const days = [...new Set(scheduleResult.map(item => item.day))];

        days.forEach(day => {
            let matchesToday = scheduleResult.filter(m => m.day === day);
            // Sort by Time then Field
            matchesToday.sort((a,b) => a.timeStart.localeCompare(b.timeStart));

            let html = `
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="bg-gray-800 text-white px-6 py-3 flex justify-between items-center">
                        <h2 class="text-xl font-bold">${day}</h2>
                        <span class="text-sm bg-gray-600 px-3 py-1 rounded-full">${matchesToday.length} ‡∏Ñ‡∏π‡πà</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="px-6 py-3">‡∏™‡∏ô‡∏≤‡∏°</th>
                                    <th class="px-6 py-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="px-6 py-3">‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</th>
                                    <th class="px-6 py-3">‡∏£‡∏≠‡∏ö</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            matchesToday.forEach(m => {
                html += `
                    <tr class="border-b hover:bg-gray-50 border-l-4 ${m.color.replace('bg-', 'border-').split(' ')[1]}">
                        <td class="px-6 py-4 font-mono font-bold text-gray-600">${m.timeStart} - ${m.timeEnd}</td>
                        <td class="px-6 py-4 font-semibold">${m.field}</td>
                        <td class="px-6 py-4">${m.sport}</td>
                        <td class="px-6 py-4 font-medium text-blue-900">${m.match}</td>
                        <td class="px-6 py-4 text-gray-500">${m.round}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div></div>`;
            container.innerHTML += html;
        });

        document.getElementById('totalMatches').innerText = scheduleResult.length;
        if(scheduleResult.length > 0) {
            let last = scheduleResult[scheduleResult.length-1];
            document.getElementById('lastMatchTime').innerText = `${last.day} ${last.timeEnd}`;
            document.getElementById('takrawStatus').innerText = "‡∏à‡∏±‡∏î‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏£‡∏ß‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
            document.getElementById('takrawStatus').className = "text-green-600 font-bold";
        }
        
        document.getElementById('outputArea').classList.remove('hidden');
    }

    // --- Main Function ---
    function generateSchedule() {
        generateMatches();
        runScheduler();
        renderSchedule();
    }

</script>

</body>
</html>
