<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School Games Schedule</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    :root { 
        --header-h: 64px; --sidebar-w: 260px;
        --primary: #2563eb; --primary-light: #eff6ff;
        --bg: #f8fafc; --text: #0f172a; --text-muted: #64748b;
        --white: #ffffff; --border: #e2e8f0;
        --c-fb: #3b82f6; --c-vb: #f97316; --c-tk: #10b981; --c-pt: #8b5cf6;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* UI Components */
    .app-header { height: var(--header-h); background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 50; }
    .brand { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: flex; gap: 10px; align-items: center; cursor: pointer; letter-spacing: -0.5px; }
    
    .day-tabs { display: flex; gap: 4px; background: #f1f5f9; padding: 4px; border-radius: 12px; }
    .day-btn { border: none; background: transparent; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; color: var(--text-muted); font-weight: 600; transition: 0.2s; }
    .day-btn:hover { color: var(--text); background: #e2e8f0; }
    .day-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

    .actions button { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border); background: var(--white); cursor: pointer; color: var(--text-muted); margin-left: 8px; transition: 0.2s; font-size: 1.1rem; }
    .actions button:hover { background: var(--primary-light); color: var(--primary); border-color: var(--primary); }

    .main-layout { flex: 1; display: flex; overflow: hidden; }
    
    /* Sidebar */
    .sidebar { width: var(--sidebar-w); background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px 0; }
    .sb-section { margin-bottom: 20px; padding: 0 16px; }
    .sb-title { font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; padding-left: 10px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: #475569; font-weight: 500; margin-bottom: 2px; transition: 0.2s; }
    .nav-item:hover { background: #f8fafc; color: var(--primary); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 700; }
    .sub-menu { margin-left: 36px; border-left: 2px solid #f1f5f9; padding-left: 10px; margin-top: 2px; display: flex; flex-direction: column; gap: 2px; }
    .sub-item { padding: 6px 10px; font-size: 0.85rem; color: #64748b; cursor: pointer; border-radius: 6px; }
    .sub-item:hover { color: var(--primary); background: #f8fafc; }
    .sub-item.active { color: var(--primary); font-weight: 600; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }

    /* Content */
    .content { flex: 1; padding: 24px; overflow-y: auto; background: #f8fafc; }
    .schedule-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 1400px) { .schedule-grid { grid-template-columns: 1fr 1fr; } }

    /* Match Card */
    .time-card { background: var(--white); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); break-inside: avoid; margin-bottom: 20px; }
    .time-head { background: #f8fafc; padding: 10px 20px; border-bottom: 1px solid var(--border); font-weight: 700; color: #334155; font-size: 1rem; }
    .time-badge { background: #334155; color: white; padding: 4px 10px; border-radius: 6px; font-family: monospace; font-size: 1.1em; margin-right: 10px; }
    
    .match-row { display: flex; padding: 16px 20px; border-bottom: 1px solid var(--border); position: relative; gap: 16px; align-items: start; }
    .match-row:last-child { border-bottom: none; }
    .match-row::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
    .b-FB::before { background: var(--c-fb); } .b-VB::before { background: var(--c-vb); }
    .b-TK::before { background: var(--c-tk); } .b-PT::before { background: var(--c-pt); }

    .m-left { width: 120px; flex-shrink: 0; display: flex; flex-direction: column; gap: 6px; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; color: white; width: fit-content; }
    .bg-FB { background: var(--c-fb); } .bg-VB { background: var(--c-vb); } .bg-TK { background: var(--c-tk); } .bg-PT { background: var(--c-pt); }
    
    .m-center { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .team-line { display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.95rem; }
    .team-placeholder { color: #94a3b8; font-style: italic; font-weight: 400; }
    .resolved { color: var(--primary); font-weight: 700; }

    /* Inputs */
    .score-group { display: flex; gap: 4px; align-items: center; }
    .set-input { width: 32px; height: 28px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: 700; color: #334155; font-size: 0.85rem; background: #f8fafc; }
    .set-input:focus { outline: 2px solid var(--primary); background: white; }
    .set-label { font-size: 0.65rem; color: #94a3b8; text-align: center; width: 32px; margin-bottom: 2px; }
    .score-main { width: 40px; height: 36px; font-size: 1.1rem; border: 2px solid #e2e8f0; color: var(--primary); }
    
    .penalty-area { margin-top: 8px; padding: 8px; background: #fff1f2; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.85rem; color: #e11d48; font-weight: 600; }

    .meta-info { display: flex; gap: 12px; font-size: 0.8rem; color: #64748b; align-items: center; margin-top: 4px; background: #f9f9f9; padding: 6px 10px; border-radius: 6px; width: fit-content; }
    .ref-badge { margin-left: auto; background: #e2e8f0; padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }

    /* Right Panel (Stats) */
    .right-panel { width: 450px; background: var(--white); border-left: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
    .rp-head { padding: 20px; font-weight: 700; border-bottom: 1px solid var(--border); background: #f8fafc; font-size: 1.1rem; color: #1e293b; display: flex; align-items: center; gap: 10px; }
    .st-container { padding: 20px; display: flex; flex-direction: column; gap: 24px; }
    .st-card { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .st-header { background: #f1f5f9; padding: 10px 15px; font-size: 0.85rem; font-weight: 700; color: #475569; border-bottom: 1px solid var(--border); }
    
    .st-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .st-table th { background: #f8fafc; padding: 8px 4px; font-weight: 600; color: #64748b; border-bottom: 1px solid var(--border); text-align: center; }
    .st-table td { padding: 8px 4px; text-align: center; border-bottom: 1px solid var(--border); color: #334155; }
    .st-table td:nth-child(2) { text-align: left; font-weight: 600; min-width: 100px; }
    .st-table tr:nth-child(even) { background: #fafbfc; }
    .hl { background: #eff6ff; color: var(--primary); font-weight: 800; }

    /* Welcome */
    .welcome-box { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #475569; }
    .welcome-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 30px; }
    .w-btn { padding: 20px; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; background: white; transition: 0.2s; display: flex; flex-direction: column; gap: 10px; align-items: center; width: 140px; }
    .w-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }

    #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #0f172a; color: white; padding: 12px 24px; border-radius: 30px; font-weight: 600; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 100; }
    #toast.show { opacity: 1; bottom: 40px; }
    
    @media (max-width: 1280px) { .right-panel { display: none; } }
</style>
</head>
<body>

<header class="app-header">
    <div class="brand" onclick="goHome()"><i class="fas fa-medal"></i> School Games 2026</div>
    <div class="day-tabs">
        <button class="day-btn" onclick="setDay(1)">วันที่ 1</button>
        <button class="day-btn" onclick="setDay(2)">วันที่ 2</button>
        <button class="day-btn" onclick="setDay(3)">วันที่ 3</button>
        <button class="day-btn" onclick="setDay(4)">วันที่ 4</button>
    </div>
    <div class="actions">
        <button title="บันทึกผล" onclick="saveToLocal()"><i class="fas fa-save"></i></button>
        <button title="รีเซ็ตตาราง" onclick="resetSystem()"><i class="fas fa-sync-alt"></i></button>
    </div>
</header>

<div class="main-layout">
    <aside class="sidebar">
        <div class="sb-section">
            <div class="nav-item active" onclick="filterSport('ALL', null)"><i class="fas fa-th-large"></i> ภาพรวม</div>
        </div>
        <div class="sb-section">
            <div class="sb-title">ฟุตบอล</div>
            <div class="sub-menu">
                <div class="sub-item" onclick="filterSport('FB', 'K')">อนุบาล</div>
                <div class="sub-item" onclick="filterSport('FB', 'PRI')">ประถมศึกษา</div>
                <div class="sub-item" onclick="filterSport('FB', 'SEC')">มัธยมศึกษา</div>
            </div>
        </div>
        <div class="sb-section">
            <div class="sb-title">วอลเลย์บอล</div>
            <div class="sub-menu">
                <div class="sub-item" onclick="filterSport('VB', 'PRI')">ประถมศึกษา</div>
                <div class="sub-item" onclick="filterSport('VB', 'SEC')">มัธยมศึกษา</div>
            </div>
        </div>
        <div class="sb-section">
            <div class="sb-title">เซปักตะกร้อ</div>
            <div class="sub-menu">
                <div class="sub-item" onclick="filterSport('TK', 'PRI')">ประถมศึกษา</div>
                <div class="sub-item" onclick="filterSport('TK', 'SEC')">มัธยมศึกษา</div>
            </div>
        </div>
        <div class="sb-section">
            <div class="sb-title">เปตอง</div>
            <div class="sub-menu">
                <div class="sub-item" onclick="filterSport('PT', 'PRI')">ประถมศึกษา</div>
                <div class="sub-item" onclick="filterSport('PT', 'SEC')">มัธยมศึกษา</div>
            </div>
        </div>
    </aside>

    <main class="content" id="mainContent">
        </main>

    <aside class="right-panel">
        <div class="rp-head"><i class="fas fa-chart-line text-blue-600"></i> ตารางคะแนน</div>
        <div class="st-container" id="standingsContent"></div>
    </aside>
</div>

<div id="toast"><i class="fas fa-check-circle"></i> บันทึกเรียบร้อย</div>

<script>
// --- DATA CONFIGURATION ---
const schools = [
    { id: 'S1', name: "โรงเรียน 1", type: 'PRI' }, { id: 'S2', name: "โรงเรียน 2", type: 'PRI' },
    { id: 'S3', name: "โรงเรียน 3", type: 'PRI' }, { id: 'S4', name: "โรงเรียน 4", type: 'PRI' },
    { id: 'S5', name: "โรงเรียน 5", type: 'PRI' }, { id: 'S6', name: "โรงเรียน 6", type: 'PRI' },
    { id: 'S7', name: "โรงเรียน 7", type: 'PRI' }, { id: 'S8', name: "โรงเรียน 8", type: 'PRI' },
    { id: 'S9', name: "โรงเรียน 9", type: 'PRI' },
    { id: 'M1', name: "โรงเรียน ก", type: 'SEC' }, { id: 'M2', name: "โรงเรียน ข", type: 'SEC' },
    { id: 'M3', name: "โรงเรียน ค", type: 'SEC' }, { id: 'M4', name: "โรงเรียน ง", type: 'SEC' }
];

const categories = [
    { id: 'FB_K_M', sp: 'FB', name: 'บอลอนุบาล ชาย', dur: 30, field: 'สนามอนุบาล', lv: 'K', gd: 'M', format: 'group' },
    { id: 'FB_K_F', sp: 'FB', name: 'บอลอนุบาล หญิง', dur: 30, field: 'สนามอนุบาล', lv: 'K', gd: 'F', format: 'group' },
    { id: 'FB_P13_M', sp: 'FB', name: 'บอล ป.ต้น ชาย', dur: 45, field: 'สนาม ป.ต้น', lv: 'P13', gd: 'M', format: 'group' },
    { id: 'FB_P13_F', sp: 'FB', name: 'บอล ป.ต้น หญิง', dur: 45, field: 'สนาม ป.ต้น', lv: 'P13', gd: 'F', format: 'group' },
    { id: 'FB_P46_M', sp: 'FB', name: 'บอล ป.ปลาย ชาย', dur: 60, field: 'สนาม ป.ปลาย', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'FB_P46_F', sp: 'FB', name: 'บอล ป.ปลาย หญิง', dur: 60, field: 'สนาม ป.ปลาย', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'FB_SEC_M', sp: 'FB', name: 'บอล มัธยม ชาย', dur: 60, field: 'สนาม มัธยม', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'FB_SEC_F', sp: 'FB', name: 'บอล มัธยม หญิง', dur: 60, field: 'สนาม มัธยม', lv: 'SEC', gd: 'F', format: 'league' },
    
    { id: 'VB_P46_M', sp: 'VB', name: 'วอลเลย์ ป.ปลาย ชาย', dur: 60, field: 'วอลเลย์ 1 (ป.ปลาย)', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'VB_P46_F', sp: 'VB', name: 'วอลเลย์ ป.ปลาย หญิง', dur: 60, field: 'วอลเลย์ 1 (ป.ปลาย)', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'VB_SEC_M', sp: 'VB', name: 'วอลเลย์ มัธยม ชาย', dur: 60, field: 'วอลเลย์ 2 (มัธยม)', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'VB_SEC_F', sp: 'VB', name: 'วอลเลย์ มัธยม หญิง', dur: 60, field: 'วอลเลย์ 2 (มัธยม)', lv: 'SEC', gd: 'F', format: 'league' },
    
    { id: 'TK_P46_M', sp: 'TK', name: 'ตะกร้อ ป.ปลาย ชาย', dur: 30, field: 'สนามตะกร้อ (รวม)', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'TK_P46_F', sp: 'TK', name: 'ตะกร้อ ป.ปลาย หญิง', dur: 30, field: 'สนามตะกร้อ (รวม)', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'TK_SEC_M', sp: 'TK', name: 'ตะกร้อ มัธยม ชาย', dur: 30, field: 'สนามตะกร้อ (รวม)', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'TK_SEC_F', sp: 'TK', name: 'ตะกร้อ มัธยม หญิง', dur: 30, field: 'สนามตะกร้อ (รวม)', lv: 'SEC', gd: 'F', format: 'league' },
    
    { id: 'PT_P46_M', sp: 'PT', name: 'เปตอง ป.ปลาย ชาย', dur: 60, field: 'เปตอง 1 (ป.ปลาย)', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'PT_P46_F', sp: 'PT', name: 'เปตอง ป.ปลาย หญิง', dur: 60, field: 'เปตอง 1 (ป.ปลาย)', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'PT_SEC_M', sp: 'PT', name: 'เปตอง มัธยม ชาย', dur: 60, field: 'เปตอง 2 (มัธยม)', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'PT_SEC_F', sp: 'PT', name: 'เปตอง มัธยม หญิง', dur: 60, field: 'เปตอง 2 (มัธยม)', lv: 'SEC', gd: 'F', format: 'league' }
];

let scheduleData = [];
let currentDay = 1;
let currentMode = 'welcome';
let currentSportFilter = 'ALL';
let currentLevelFilter = null;

// Helper to get Objects
const getSchool = (id) => schools.find(s=>s.id===id) || {id, name:id};
const getCat = (id) => categories.find(c=>c.id===id);
const S = (id) => getSchool(id);

// --- FIXED SCHEDULE (Based on User Requirements) ---
const rawSchedule = [
    // --- DAY 1 (13:00 - 16:30) ---
    // FB Anuban
    { d:1, t:780, c:'FB_K_M', t1:'S1', t2:'S2', r:'โรงเรียน 4', st:'GROUP', g:'A' },
    { d:1, t:810, c:'FB_K_F', t1:'S1', t2:'S2', r:'โรงเรียน 4', st:'GROUP', g:'A' },
    { d:1, t:840, c:'FB_K_M', t1:'S4', t2:'S5', r:'โรงเรียน 7', st:'GROUP', g:'B' },
    { d:1, t:870, c:'FB_K_F', t1:'S4', t2:'S5', r:'โรงเรียน 7', st:'GROUP', g:'B' },
    { d:1, t:900, c:'FB_K_M', t1:'S7', t2:'S8', r:'โรงเรียน 1', st:'GROUP', g:'C' },
    { d:1, t:930, c:'FB_K_F', t1:'S7', t2:'S8', r:'โรงเรียน 1', st:'GROUP', g:'C' },
    // FB Pri Low (45 min)
    { d:1, t:780, c:'FB_P13_M', t1:'S1', t2:'S2', r:'โรงเรียน 4', st:'GROUP', g:'A' },
    { d:1, t:825, c:'FB_P13_F', t1:'S1', t2:'S2', r:'โรงเรียน 4', st:'GROUP', g:'A' },
    { d:1, t:870, c:'FB_P13_M', t1:'S4', t2:'S5', r:'โรงเรียน 7', st:'GROUP', g:'B' },
    { d:1, t:915, c:'FB_P13_F', t1:'S4', t2:'S5', r:'โรงเรียน 7', st:'GROUP', g:'B' },
    // FB Pri High (60 min)
    { d:1, t:780, c:'FB_P46_M', t1:'S1', t2:'S2', r:'โรงเรียน 6', st:'GROUP', g:'A' },
    { d:1, t:840, c:'FB_P46_F', t1:'S4', t2:'S5', r:'โรงเรียน 9', st:'GROUP', g:'B' },
    { d:1, t:900, c:'FB_P46_M', t1:'S7', t2:'S8', r:'โรงเรียน 3', st:'GROUP', g:'C' },
    // VB (60 min)
    { d:1, t:780, c:'VB_P46_M', t1:'S4', t2:'S5', r:'โรงเรียน 9', st:'GROUP', g:'B' },
    { d:1, t:840, c:'VB_P46_F', t1:'S7', t2:'S8', r:'โรงเรียน 3', st:'GROUP', g:'C' },
    { d:1, t:900, c:'VB_P46_M', t1:'S1', t2:'S2', r:'โรงเรียน 6', st:'GROUP', g:'A' },
    // PT (60 min)
    { d:1, t:780, c:'PT_P46_M', t1:'S7', t2:'S8', r:'โรงเรียน 3', st:'GROUP', g:'C' },
    { d:1, t:840, c:'PT_P46_F', t1:'S1', t2:'S2', r:'โรงเรียน 6', st:'GROUP', g:'A' },
    { d:1, t:900, c:'PT_P46_M', t1:'S4', t2:'S5', r:'โรงเรียน 9', st:'GROUP', g:'B' },
    // SEC FB
    { d:1, t:780, c:'FB_SEC_M', t1:'M1', t2:'M2', r:'โรงเรียน ค', st:'LEAGUE' },
    { d:1, t:840, c:'FB_SEC_F', t1:'M3', t2:'M4', r:'โรงเรียน ก', st:'LEAGUE' },
    // SEC VB
    { d:1, t:900, c:'VB_SEC_M', t1:'M3', t2:'M4', r:'โรงเรียน ข', st:'LEAGUE' },
    { d:1, t:960, c:'VB_SEC_F', t1:'M1', t2:'M2', r:'โรงเรียน ง', st:'LEAGUE' },
    // TK
    { d:1, t:780, c:'TK_SEC_M', t1:'M1', t2:'M2', r:'โรงเรียน ค', st:'LEAGUE' },
    { d:1, t:810, c:'TK_SEC_F', t1:'M3', t2:'M4', r:'โรงเรียน ก', st:'LEAGUE' },
    { d:1, t:840, c:'TK_P46_M', t1:'S7', t2:'S9', r:'โรงเรียน 4', st:'GROUP', g:'C' },
    { d:1, t:870, c:'TK_P46_F', t1:'S1', t2:'S3', r:'โรงเรียน 7', st:'GROUP', g:'A' },
    { d:1, t:900, c:'TK_P46_M', t1:'S4', t2:'S6', r:'โรงเรียน 1', st:'GROUP', g:'B' },

    // --- DAY 2 (13:00 - 16:30) ---
    // FB Anuban
    { d:2, t:780, c:'FB_K_M', t1:'S2', t2:'S3', r:'โรงเรียน 5', st:'GROUP', g:'A' },
    { d:2, t:810, c:'FB_K_F', t1:'S2', t2:'S3', r:'โรงเรียน 5', st:'GROUP', g:'A' },
    { d:2, t:840, c:'FB_K_M', t1:'S5', t2:'S6', r:'โรงเรียน 8', st:'GROUP', g:'B' },
    { d:2, t:870, c:'FB_K_F', t1:'S5', t2:'S6', r:'โรงเรียน 8', st:'GROUP', g:'B' },
    { d:2, t:900, c:'FB_K_M', t1:'S8', t2:'S9', r:'โรงเรียน 2', st:'GROUP', g:'C' },
    { d:2, t:930, c:'FB_K_F', t1:'S8', t2:'S9', r:'โรงเรียน 2', st:'GROUP', g:'C' },
    // FB Pri Low
    { d:2, t:780, c:'FB_P13_M', t1:'S2', t2:'S3', r:'โรงเรียน 5', st:'GROUP', g:'A' },
    { d:2, t:825, c:'FB_P13_F', t1:'S2', t2:'S3', r:'โรงเรียน 5', st:'GROUP', g:'A' },
    { d:2, t:870, c:'FB_P13_M', t1:'S5', t2:'S6', r:'โรงเรียน 8', st:'GROUP', g:'B' },
    { d:2, t:915, c:'FB_P13_F', t1:'S5', t2:'S6', r:'โรงเรียน 8', st:'GROUP', g:'B' },
    // FB Pri High
    { d:2, t:780, c:'FB_P46_F', t1:'S1', t2:'S2', r:'โรงเรียน 6', st:'GROUP', g:'A' },
    { d:2, t:840, c:'FB_P46_M', t1:'S4', t2:'S5', r:'โรงเรียน 9', st:'GROUP', g:'B' },
    { d:2, t:900, c:'FB_P46_F', t1:'S7', t2:'S8', r:'โรงเรียน 3', st:'GROUP', g:'C' },
    // VB
    { d:2, t:780, c:'VB_P46_F', t1:'S4', t2:'S5', r:'โรงเรียน 9', st:'GROUP', g:'B' },
    { d:2, t:840, c:'VB_P46_M', t1:'S7', t2:'S8', r:'โรงเรียน 3', st:'GROUP', g:'C' },
    { d:2, t:900, c:'VB_P46_F', t1:'S1', t2:'S2', r:'โรงเรียน 6', st:'GROUP', g:'A' },
    // PT
    { d:2, t:780, c:'PT_P46_F', t1:'S7', t2:'S8', r:'โรงเรียน 3', st:'GROUP', g:'C' },
    { d:2, t:840, c:'PT_P46_M', t1:'S1', t2:'S2', r:'โรงเรียน 6', st:'GROUP', g:'A' },
    { d:2, t:900, c:'PT_P46_F', t1:'S4', t2:'S5', r:'โรงเรียน 9', st:'GROUP', g:'B' },
    // SEC FB
    { d:2, t:780, c:'FB_SEC_M', t1:'M1', t2:'M3', r:'โรงเรียน ง', st:'LEAGUE' },
    { d:2, t:840, c:'FB_SEC_F', t1:'M2', t2:'M4', r:'โรงเรียน ก', st:'LEAGUE' },
    // SEC VB
    { d:2, t:900, c:'VB_SEC_M', t1:'M1', t2:'M2', r:'โรงเรียน ง', st:'LEAGUE' },
    { d:2, t:960, c:'VB_SEC_F', t1:'M3', t2:'M4', r:'โรงเรียน ข', st:'LEAGUE' },
    // TK
    { d:2, t:780, c:'TK_SEC_M', t1:'M1', t2:'M3', r:'โรงเรียน ง', st:'LEAGUE' },
    { d:2, t:810, c:'TK_SEC_F', t1:'M2', t2:'M4', r:'โรงเรียน ก', st:'LEAGUE' },
    { d:2, t:840, c:'TK_P46_M', t1:'S2', t2:'S3', r:'โรงเรียน 5', st:'GROUP', g:'A' },
    { d:2, t:870, c:'TK_P46_F', t1:'S5', t2:'S6', r:'โรงเรียน 8', st:'GROUP', g:'B' },
    { d:2, t:900, c:'TK_P46_M', t1:'S8', t2:'S9', r:'โรงเรียน 2', st:'GROUP', g:'C' },

    // --- DAY 3 (08:30 - 16:30) ---
    // FB Anuban (Group Last + Semi)
    { d:3, t:510, c:'FB_K_M', t1:'S1', t2:'S3', r:'โรงเรียน 9', st:'GROUP', g:'A' },
    { d:3, t:510, c:'FB_K_F', t1:'S1', t2:'S3', r:'โรงเรียน 9', st:'GROUP', g:'A' }, // Sperate field? Assume sharing/split. 
    { d:3, t:540, c:'FB_K_M', t1:'S4', t2:'S6', r:'โรงเรียน 2', st:'GROUP', g:'B' },
    { d:3, t:540, c:'FB_K_F', t1:'S4', t2:'S6', r:'โรงเรียน 2', st:'GROUP', g:'B' },
    { d:3, t:570, c:'FB_K_M', t1:'S7', t2:'S9', r:'โรงเรียน 5', st:'GROUP', g:'C' },
    { d:3, t:570, c:'FB_K_F', t1:'S7', t2:'S9', r:'โรงเรียน 5', st:'GROUP', g:'C' },
    // Semi Anuban
    { d:3, t:630, c:'FB_K_M', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:630, c:'FB_K_F', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:660, c:'FB_K_M', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:660, c:'FB_K_F', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },

    // FB Pri Low (Group Last + Semi)
    { d:3, t:510, c:'FB_P13_M', t1:'S1', t2:'S3', r:'โรงเรียน 9', st:'GROUP', g:'A' },
    { d:3, t:555, c:'FB_P13_F', t1:'S1', t2:'S3', r:'โรงเรียน 9', st:'GROUP', g:'A' },
    { d:3, t:600, c:'FB_P13_M', t1:'S4', t2:'S6', r:'โรงเรียน 2', st:'GROUP', g:'B' },
    { d:3, t:645, c:'FB_P13_F', t1:'S4', t2:'S6', r:'โรงเรียน 2', st:'GROUP', g:'B' },
    { d:3, t:690, c:'FB_P13_M', t1:'S7', t2:'S9', r:'โรงเรียน 5', st:'GROUP', g:'C' },
    { d:3, t:735, c:'FB_P13_F', t1:'S7', t2:'S9', r:'โรงเรียน 5', st:'GROUP', g:'C' },
    // Semi Pri Low
    { d:3, t:780, c:'FB_P13_M', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:825, c:'FB_P13_F', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:870, c:'FB_P13_M', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:915, c:'FB_P13_F', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },

    // FB Pri High
    { d:3, t:510, c:'FB_P46_M', t1:'S3', t2:'S1', r:'โรงเรียน 5', st:'GROUP', g:'A' },
    { d:3, t:570, c:'FB_P46_F', t1:'S6', t2:'S4', r:'โรงเรียน 8', st:'GROUP', g:'B' },
    { d:3, t:630, c:'FB_P46_M', t1:'S9', t2:'S7', r:'โรงเรียน 2', st:'GROUP', g:'C' },
    { d:3, t:780, c:'FB_P46_F', t1:'S3', t2:'S1', r:'โรงเรียน 5', st:'GROUP', g:'A' }, // 13:00 start
    { d:3, t:840, c:'FB_P46_M', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:900, c:'FB_P46_F', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:960, c:'FB_P46_M', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },

    // VB
    { d:3, t:510, c:'VB_P46_M', t1:'S6', t2:'S4', r:'โรงเรียน 8', st:'GROUP', g:'B' },
    { d:3, t:570, c:'VB_P46_F', t1:'S9', t2:'S7', r:'โรงเรียน 2', st:'GROUP', g:'C' },
    { d:3, t:630, c:'VB_P46_M', t1:'S3', t2:'S1', r:'โรงเรียน 5', st:'GROUP', g:'A' },
    { d:3, t:780, c:'VB_P46_M', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:840, c:'VB_P46_F', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:900, c:'VB_P46_M', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },

    // SEC FB
    { d:3, t:510, c:'FB_SEC_M', t1:'M1', t2:'M4', r:'โรงเรียน ข', st:'LEAGUE' },
    { d:3, t:570, c:'FB_SEC_F', t1:'M2', t2:'M3', r:'โรงเรียน ง', st:'LEAGUE' },
    { d:3, t:630, c:'FB_SEC_M', t1:'M2', t2:'M3', r:'โรงเรียน ก', st:'LEAGUE' },
    { d:3, t:780, c:'FB_SEC_F', t1:'M1', t2:'M4', r:'โรงเรียน ค', st:'LEAGUE' },

    // TK (Compressed)
    { d:3, t:510, c:'TK_SEC_M', t1:'M1', t2:'M4', r:'โรงเรียน ข', st:'LEAGUE' },
    { d:3, t:540, c:'TK_SEC_M', t1:'M2', t2:'M3', r:'โรงเรียน ง', st:'LEAGUE' },
    { d:3, t:570, c:'TK_SEC_F', t1:'M1', t2:'M4', r:'โรงเรียน ค', st:'LEAGUE' },
    { d:3, t:600, c:'TK_SEC_F', t1:'M2', t2:'M3', r:'โรงเรียน ก', st:'LEAGUE' },
    { d:3, t:630, c:'TK_P46_M', t1:'S1', t2:'S3', r:'โรงเรียน 7', st:'GROUP', g:'A' },
    { d:3, t:660, c:'TK_P46_F', t1:'S4', t2:'S6', r:'โรงเรียน 1', st:'GROUP', g:'B' },
    { d:3, t:690, c:'TK_P46_M', t1:'S7', t2:'S9', r:'โรงเรียน 4', st:'GROUP', g:'C' },
    { d:3, t:720, c:'TK_P46_F', t1:'S7', t2:'S9', r:'โรงเรียน 5', st:'GROUP', g:'C' },
    { d:3, t:750, c:'TK_P46_M', t1:'S4', t2:'S6', r:'โรงเรียน 8', st:'GROUP', g:'B' },
    { d:3, t:780, c:'TK_P46_F', t1:'S2', t2:'S3', r:'โรงเรียน 2', st:'GROUP', g:'A' },
    { d:3, t:810, c:'TK_P46_M', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:840, c:'TK_P46_F', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:870, c:'TK_P46_M', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:900, c:'TK_P46_F', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },

    // PT (Assuming Group last + Semi similar pattern, omitted slightly to save space but keeping key rounds)
    { d:3, t:510, c:'PT_P46_M', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:570, c:'PT_P46_F', t1:'W_A', t2:'BEST_2', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:630, c:'PT_P46_M', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:690, c:'PT_P46_F', t1:'W_B', t2:'W_C', r:'ทีมตกรอบ', st:'SEMI', isKO:true },
    { d:3, t:780, c:'PT_SEC_M', t1:'M1', t2:'M4', r:'โรงเรียน ข', st:'LEAGUE' },
    { d:3, t:840, c:'PT_SEC_F', t1:'M2', t2:'M3', r:'โรงเรียน ง', st:'LEAGUE' },

    // --- DAY 4 (Finals) ---
    // Morning: 3rd Place
    { d:4, t:510, c:'FB_K_M', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:540, c:'FB_K_F', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:540, c:'FB_P13_M', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:600, c:'FB_P13_F', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:540, c:'FB_P46_M', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:630, c:'FB_P46_F', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:540, c:'VB_P46_M', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:630, c:'VB_P46_F', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:540, c:'TK_P46_M', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:570, c:'TK_P46_F', t1:'L_SF1', t2:'L_SF2', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    // Sec 3rd (Rank 3 vs 4)
    { d:4, t:660, c:'FB_SEC_M', t1:'R3', t2:'R4', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:720, c:'FB_SEC_F', t1:'R3', t2:'R4', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:720, c:'VB_SEC_M', t1:'R3', t2:'R4', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },
    { d:4, t:780, c:'VB_SEC_F', t1:'R3', t2:'R4', r:'กก.กลาง', st:'FINAL_3RD', isKO:true },

    // Afternoon: Finals (1st)
    { d:4, t:780, c:'FB_K_M', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:810, c:'FB_K_F', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:840, c:'FB_P13_M', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:885, c:'FB_P13_F', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:780, c:'FB_P46_M', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:840, c:'FB_P46_F', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:780, c:'VB_P46_M', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:840, c:'VB_P46_F', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:780, c:'TK_P46_M', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:810, c:'TK_P46_F', t1:'W_SF1', t2:'W_SF2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    // Sec Final
    { d:4, t:900, c:'FB_SEC_M', t1:'R1', t2:'R2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:960, c:'FB_SEC_F', t1:'R1', t2:'R2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:900, c:'VB_SEC_M', t1:'R1', t2:'R2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true },
    { d:4, t:960, c:'VB_SEC_F', t1:'R1', t2:'R2', r:'กก.กลาง', st:'FINAL_1ST', isKO:true }
];

function generateSchedule() {
    let matches = [];
    rawSchedule.forEach((m, idx) => {
        let cat = getCat(m.c);
        let t1 = m.t1.length > 3 ? {id:m.t1, name:m.t1} : getSchool(m.t1); // Handle W_A etc later
        let t2 = m.t2.length > 3 ? {id:m.t2, name:m.t2} : getSchool(m.t2);
        
        matches.push({
            uid: `${m.c}_${idx}`, 
            cat: cat,
            round: m.st.includes('FINAL') ? (m.st.includes('1ST')?'ชิงชนะเลิศ':'ชิงที่ 3') : (m.st==='SEMI'?'รอบรองชนะเลิศ':'รอบแรก'),
            t1: {id: m.t1, name: (t1?t1.name:m.t1)}, 
            t2: {id: m.t2, name: (t2?t2.name:m.t2)},
            stage: m.st,
            group: m.g,
            day: m.d,
            timeStart: m.t,
            timeEnd: m.t + cat.dur,
            referee: m.r,
            s: { s1:[null,null,null], s2:[null,null,null] },
            pen: {p1:null, p2:null}
        });
    });
    return matches;
}

// --- STATS ENGINE ---
function calcMatchResult(m) {
    if(m.cat.sp === 'VB' || m.cat.sp === 'TK') {
        let setW1 = 0, setW2 = 0;
        for(let i=0; i<3; i++) {
            if(m.s.s1[i] && m.s.s2[i]) {
                if(parseInt(m.s.s1[i]) > parseInt(m.s.s2[i])) setW1++;
                else setW2++;
            }
        }
        if(setW1 === 0 && setW2 === 0) return null;
        let w = setW1 > setW2 ? m.t1 : m.t2;
        return { winner: w, loser: (w===m.t1 ? m.t2 : m.t1), score: `${setW1}-${setW2}`, setW1, setW2 };
    } else {
        if(!m.s.s1[0] || !m.s.s2[0]) return null;
        let sc1 = parseInt(m.s.s1[0]), sc2 = parseInt(m.s.s2[0]);
        if(sc1 > sc2) return { winner: m.t1, loser: m.t2, score: `${sc1}-${sc2}`, d: false };
        if(sc2 > sc1) return { winner: m.t2, loser: m.t1, score: `${sc1}-${sc2}`, d: false };
        if(m.stage.includes('SEMI') || m.stage.includes('FINAL')) {
            if(m.pen.p1 && m.pen.p2) {
                let p1 = parseInt(m.pen.p1), p2 = parseInt(m.pen.p2);
                return { winner: (p1>p2 ? m.t1 : m.t2), loser: (p1>p2 ? m.t2 : m.t1), score: `${sc1}-${sc2} (P${p1}-${p2})`, d: false };
            }
            return { winner: null, loser: null, score: `${sc1}-${sc2}`, d: true, needPen: true };
        }
        return { winner: null, loser: null, score: `${sc1}-${sc2}`, d: true };
    }
}

function resolveTeamNames() {
    let stats = calculateStandings();
    scheduleData.forEach(m => {
        if(m.stage.includes('SEMI') || m.stage.includes('FINAL')) {
            let res1 = resolvePlaceholder({id:m.t1.id, name:m.t1.name}, m.cat.id, stats[m.cat.id] || {});
            let res2 = resolvePlaceholder({id:m.t2.id, name:m.t2.name}, m.cat.id, stats[m.cat.id] || {});
            if(res1.isResolved) { m.t1.name = res1.name; m.t1.isResolved = true; }
            if(res2.isResolved) { m.t2.name = res2.name; m.t2.isResolved = true; }
        }
    });
}

function calculateStandings() {
    let stats = {};
    categories.forEach(cat => {
        stats[cat.id] = {};
        let matches = scheduleData.filter(m => m.cat.id === cat.id && (m.stage === 'GROUP' || m.stage === 'LEAGUE'));
        matches.forEach(m => {
            let res = calcMatchResult(m);
            if(!res) return;
            const initStat = (id, name, group) => {
                if(!stats[cat.id][id]) stats[cat.id][id] = { id, name, G: group, P:0, W:0, D:0, L:0, GF:0, GA:0, Pts:0, SW:0, SL:0, PW:0, PL:0 };
            };
            initStat(m.t1.id, m.t1.name, m.group || 'L');
            initStat(m.t2.id, m.t2.name, m.group || 'L');
            let s1 = stats[cat.id][m.t1.id];
            let s2 = stats[cat.id][m.t2.id];
            s1.P++; s2.P++;
            if(cat.sp === 'VB' || cat.sp === 'TK') {
                s1.SW += res.setW1; s1.SL += res.setW2;
                s2.SW += res.setW2; s2.SL += res.setW1;
                for(let i=0; i<3; i++) {
                    if(m.s.s1[i] && m.s.s2[i]) {
                        s1.PW += parseInt(m.s.s1[i]); s1.PL += parseInt(m.s.s2[i]);
                        s2.PW += parseInt(m.s.s2[i]); s2.PL += parseInt(m.s.s1[i]);
                    }
                }
                if(res.winner.id === m.t1.id) { s1.W++; s1.Pts += 3; s2.L++; } else { s2.W++; s2.Pts += 3; s1.L++; }
            } else {
                let sc1 = parseInt(m.s.s1[0]), sc2 = parseInt(m.s.s2[0]);
                s1.GF += sc1; s1.GA += sc2; s2.GF += sc2; s2.GA += sc1;
                if(res.d) { s1.D++; s2.D++; s1.Pts+=1; s2.Pts+=1; }
                else if(res.winner.id === m.t1.id) { s1.W++; s1.Pts+=3; s2.L++; }
                else { s2.W++; s2.Pts+=3; s1.L++; }
            }
        });
    });
    return stats;
}

function resolvePlaceholder(teamObj, catId, catStats) {
    if(!['W_','L_','R','BEST'].some(k => teamObj.id.startsWith(k))) return teamObj;
    const sortFn = (a,b) => {
        if(b.Pts !== a.Pts) return b.Pts - a.Pts;
        if(a.GF !== undefined) {
            let gdA = a.GF - a.GA, gdB = b.GF - b.GA;
            if(gdA !== gdB) return gdB - gdA;
            return b.GF - a.GF;
        }
        if(a.SW !== undefined) {
            let sA = a.SW - a.SL, sB = b.SW - b.SL;
            if(sA !== sB) return sB - sA;
            return (b.PW - b.PL) - (a.PW - a.PL);
        }
        return 0;
    };
    let allTeams = Object.values(catStats);
    const getRank = (g, idx) => allTeams.filter(t => t.G === g).sort(sortFn)[idx];

    if(teamObj.id === 'W_A') { let t = getRank('A',0); if(t) return {name:t.name, id:t.id, isResolved:true}; }
    if(teamObj.id === 'W_B') { let t = getRank('B',0); if(t) return {name:t.name, id:t.id, isResolved:true}; }
    if(teamObj.id === 'W_C') { let t = getRank('C',0); if(t) return {name:t.name, id:t.id, isResolved:true}; }
    if(teamObj.id === 'BEST_2') {
        let seconds = [];
        ['A','B','C'].forEach(g => { let s = getRank(g,1); if(s) seconds.push(s); });
        seconds.sort(sortFn);
        if(seconds[0]) return {name:seconds[0].name, id:seconds[0].id, isResolved:true};
    }
    if(teamObj.id.startsWith('R')) {
        let r = parseInt(teamObj.id.replace('R','')) - 1;
        let t = allTeams.sort(sortFn)[r];
        if(t) return {name:t.name, id:t.id, isResolved:true};
    }
    if(teamObj.id.includes('SF')) {
        let refId = teamObj.id.replace('W_','').replace('L_','');
        let prev = scheduleData.find(m => m.uid.includes(refId)); // Note: simple check
        // Better Ref Search
        if(!prev) {
            let p1 = scheduleData.find(m => m.stage==='SEMI' && m.cat.id===catId && m.t1.id==='W_A'); // SF1
            let p2 = scheduleData.find(m => m.stage==='SEMI' && m.cat.id===catId && m.t1.id==='W_B'); // SF2
            if(refId === 'SF1') prev = p1; else prev = p2;
        }
        if(prev) {
            let res = calcMatchResult(prev);
            if(res && res.winner) {
                if(teamObj.id.startsWith('W_')) return {name:res.winner.name, id:res.winner.id, isResolved:true};
                if(teamObj.id.startsWith('L_')) return {name:res.loser.name, id:res.loser.id, isResolved:true};
            }
        }
    }
    return teamObj;
}

// --- UI FUNCTIONS ---
function goHome() { 
    currentMode = 'welcome'; currentSportFilter = 'ALL';
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active'));
    renderSchedule(); 
}
function setDay(d) { 
    currentMode = 'schedule'; currentDay = d; 
    document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active')); 
    event.target.classList.add('active'); 
    renderSchedule(); 
}
function filterSport(sp, level) { 
    currentMode = 'schedule'; currentSportFilter = sp; currentLevelFilter = level;
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); 
    document.querySelectorAll('.sub-item').forEach(b=>b.classList.remove('active'));
    if (level) event.target.classList.add('active'); else event.currentTarget.classList.add('active');
    renderSchedule(); renderStandings(); 
}
function formatTime(min) { let h = Math.floor(min/60), m = min%60; return `${h.toString().padStart(2,'0')}.${m.toString().padStart(2,'0')}`; }

function renderSchedule() {
    const container = document.getElementById('mainContent');
    container.innerHTML = '';
    if (currentMode === 'welcome') {
        container.innerHTML = `<div class="welcome-box"><i class="fas fa-medal welcome-icon" style="font-size:3rem; margin-bottom:20px; color:#cbd5e1;"></i><div style="font-size:1.5rem; font-weight:700;">ยินดีต้อนรับสู่ระบบจัดการแข่งขัน</div><div class="welcome-grid"><div class="w-btn" onclick="filterSport('FB', null)"><i class="fas fa-futbol" style="color:var(--c-fb)"></i><span>ฟุตบอล</span></div><div class="w-btn" onclick="filterSport('VB', null)"><i class="fas fa-volleyball-ball" style="color:var(--c-vb)"></i><span>วอลเลย์บอล</span></div><div class="w-btn" onclick="filterSport('TK', null)"><i class="fas fa-baseball-ball" style="color:var(--c-tk)"></i><span>เซปักตะกร้อ</span></div><div class="w-btn" onclick="filterSport('PT', null)"><i class="fas fa-bowling-ball" style="color:var(--c-pt)"></i><span>เปตอง</span></div></div></div>`;
        return;
    }

    resolveTeamNames();
    let list = scheduleData.filter(m => m.day === currentDay);
    if(currentSportFilter !== 'ALL') {
        list = list.filter(m => m.cat.sp === currentSportFilter);
        if(currentLevelFilter) {
            if(currentLevelFilter === 'K') list = list.filter(m => m.cat.lv === 'K');
            else if(currentLevelFilter === 'PRI') list = list.filter(m => m.cat.lv === 'P13' || m.cat.lv === 'P46');
            else if(currentLevelFilter === 'SEC') list = list.filter(m => m.cat.lv === 'SEC');
        }
    }
    list.sort((a,b) => a.timeStart - b.timeStart);
    if(list.length === 0) { container.innerHTML = `<div style="text-align:center; padding:60px; color:#94a3b8;"><i class="far fa-calendar-times" style="font-size:2rem; margin-bottom:20px;"></i><br>ไม่มีการแข่งขัน</div>`; return; }

    let times = [...new Set(list.map(m => m.timeStart))].sort((a,b)=>a-b);
    times.forEach(t => {
        let items = list.filter(m => m.timeStart === t);
        let card = document.createElement('div'); card.className = 'time-card';
        let rows = items.map(m => {
            let t1Class = m.t1.isResolved || !m.t1.id.startsWith('W_') && !m.t1.id.startsWith('L_') && !m.t1.id.startsWith('BEST') && !m.t1.id.startsWith('R') ? 'resolved' : 'team-placeholder';
            let t2Class = m.t2.isResolved || !m.t2.id.startsWith('W_') && !m.t2.id.startsWith('L_') && !m.t2.id.startsWith('BEST') && !m.t2.id.startsWith('R') ? 'resolved' : 'team-placeholder';
            
            // Build Inputs
            let inputHtml = '';
            let isSetGame = (m.cat.sp === 'VB' || m.cat.sp === 'TK');
            if(isSetGame) {
                for(let i=0; i<3; i++) {
                    inputHtml += `<div class="score-group"><div style="display:flex; flex-direction:column;"><div class="set-label">S${i+1}</div><input type="text" class="set-input" value="${m.s.s1[i]||''}" onchange="updS('${m.uid}', 1, ${i}, this.value)"></div><span style="font-size:0.7rem;">:</span><div style="display:flex; flex-direction:column;"><div class="set-label">S${i+1}</div><input type="text" class="set-input" value="${m.s.s2[i]||''}" onchange="updS('${m.uid}', 2, ${i}, this.value)"></div></div>`;
                }
            } else {
                inputHtml = `<div class="score-group"><input type="text" class="score-main" value="${m.s.s1[0]||''}" onchange="updS('${m.uid}', 1, 0, this.value)"></div><div class="score-group"><input type="text" class="score-main" value="${m.s.s2[0]||''}" onchange="updS('${m.uid}', 2, 0, this.value)"></div>`;
            }

            let penHtml = '';
            let res = calcMatchResult(m);
            if(res && res.needPen) {
                penHtml = `<div class="penalty-area"><span><i class="fas fa-exclamation-circle"></i> เสมอ (ยิงจุดโทษ)</span> <input type="text" class="set-input" placeholder="A" value="${m.pen.p1||''}" onchange="updP('${m.uid}',1,this.value)"> : <input type="text" class="set-input" placeholder="B" value="${m.pen.p2||''}" onchange="updP('${m.uid}',2,this.value)"></div>`;
            }

            return `<div class="match-row b-${m.cat.sp}"><div class="m-left"><span class="badge bg-${m.cat.sp}">${m.cat.sp}</span><span style="font-size:0.75rem; color:#64748b; font-weight:600;">${m.cat.lv} ${m.cat.gd}</span></div><div class="m-center"><div class="team-line"><span class="${t1Class}">${m.t1.name}</span><span class="${t2Class}" style="text-align:right">${m.t2.name}</span></div><div style="display:flex; justify-content:center; gap:20px; align-items:center; margin-top:5px;">${inputHtml}</div>${penHtml}<div class="meta-info"><span>${m.cat.field}</span> <span>•</span> <span>${m.round}</span><span class="ref-badge"><i class="fas fa-user-shield"></i> ${m.referee}</span></div></div></div>`;
        }).join('');
        card.innerHTML = `<div class="time-head"><span class="time-badge">${formatTime(t)} น.</span></div>${rows}`;
        container.appendChild(card);
    });
}

function renderStandings() {
    const container = document.getElementById('standingsContent');
    container.innerHTML = '';
    if(currentSportFilter === 'ALL') { container.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">เลือกกีฬาเพื่อดูคะแนน</div>`; return; }

    let stats = calculateStandings();
    let targetCats = categories.filter(c => c.sp === currentSportFilter);
    if(currentLevelFilter) {
        if(currentLevelFilter === 'K') targetCats = targetCats.filter(c => c.lv === 'K');
        else if(currentLevelFilter === 'PRI') targetCats = targetCats.filter(c => c.lv === 'P13' || c.lv === 'P46');
        else if(currentLevelFilter === 'SEC') targetCats = targetCats.filter(c => c.lv === 'SEC');
    }

    targetCats.forEach(cat => {
        let catStats = Object.values(stats[cat.id] || {});
        if(catStats.length === 0) return;
        const sortFn = (a,b) => {
            if(b.Pts !== a.Pts) return b.Pts - a.Pts;
            if(cat.sp === 'FB' || cat.sp === 'PT') { return (b.GF - b.GA) - (a.GF - a.GA); }
            else { return (b.SW - b.SL) - (a.SW - a.SL); }
        };
        const buildTable = (teams) => {
            teams.sort(sortFn);
            if(teams.length === 0) return '';
            let isSet = (cat.sp === 'VB' || cat.sp === 'TK');
            let header = isSet ? 
                `<tr><th>#</th><th>ทีม</th><th>แข่ง</th><th>ชนะ</th><th>แพ้</th><th>ได้</th><th>เสีย</th><th>แต้ม</th></tr>` :
                `<tr><th>#</th><th>ทีม</th><th>แข่ง</th><th>ชนะ</th><th>เสมอ</th><th>แพ้</th><th>ได้</th><th>เสีย</th><th>+/-</th><th>แต้ม</th></tr>`;
            let rows = teams.map((t, i) => {
                if(isSet) return `<tr><td>${i+1}</td><td>${t.name}</td><td>${t.P}</td><td>${t.W}</td><td>${t.L}</td><td>${t.SW}</td><td>${t.SL}</td><td class="hl">${t.Pts}</td></tr>`;
                else return `<tr><td>${i+1}</td><td>${t.name}</td><td>${t.P}</td><td>${t.W}</td><td>${t.D}</td><td>${t.L}</td><td>${t.GF}</td><td>${t.GA}</td><td>${t.GF-t.GA}</td><td class="hl">${t.Pts}</td></tr>`;
            }).join('');
            return `<table class="st-table">${header}${rows}</table>`;
        };
        let bodyHtml = '';
        if(cat.format === 'group') {
            ['A','B','C'].forEach(g => {
                let html = buildTable(catStats.filter(t => t.G === g));
                if(html) bodyHtml += `<div style="background:#f1f5f9; padding:6px 15px; font-weight:700; color:#64748b; font-size:0.8rem;">สาย ${g}</div>${html}`;
            });
        } else {
            let html = buildTable(catStats);
            if(html) bodyHtml += html;
        }
        if(bodyHtml) {
            let card = document.createElement('div'); card.className = 'st-card';
            card.innerHTML = `<div class="st-header">${cat.name}</div>${bodyHtml}`;
            container.appendChild(card);
        }
    });
}

function updS(uid, teamIdx, setIdx, val) {
    let m = scheduleData.find(x => x.uid === uid);
    if(m) {
        if(teamIdx===1) m.s.s1[setIdx] = val; else m.s.s2[setIdx] = val;
        saveToLocal(true); renderSchedule(); renderStandings();
    }
}
function updP(uid, teamIdx, val) {
    let m = scheduleData.find(x => x.uid === uid);
    if(m) {
        if(teamIdx===1) m.pen.p1 = val; else m.pen.p2 = val;
        saveToLocal(true); renderSchedule();
    }
}
function saveToLocal(silent) { localStorage.setItem('school_games_2026_fixed', JSON.stringify(scheduleData)); if(!silent) { let t=document.getElementById('toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); } }
function resetSystem() { if(confirm('รีเซ็ตข้อมูลทั้งหมด?')) { localStorage.removeItem('school_games_2026_fixed'); location.reload(); } }
window.onload = () => { let saved = localStorage.getItem('school_games_2026_fixed'); if(saved) scheduleData = JSON.parse(saved); else scheduleData = generateSchedule(); renderSchedule(); renderStandings(); };
</script>
</body>
</html>
