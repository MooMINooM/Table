<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nonsawan Games 2025 (Modern UI)</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&family=Chakra+Petch:wght@600&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    :root { 
        --primary: #2563eb; --primary-light: #eff6ff;
        --bg: #f3f4f6; --surface: #ffffff;
        --text-main: #1f2937; --text-sub: #6b7280;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius: 16px;
        --header-h: 70px; --sidebar-w: 260px;
        /* Sports Colors */
        --c-fb: #3b82f6; --c-vb: #f97316; --c-tk: #10b981; --c-pt: #8b5cf6;
    }

    * { box-sizing: border-box; }
    body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* Glassmorphism Header */
    .app-header {
        height: var(--header-h);
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255,255,255,0.3);
        display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
        position: fixed; top: 0; left: 0; right: 0; z-index: 50;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 12px; cursor: pointer; letter-spacing: -0.5px; }
    
    .day-selector { background: #e5e7eb; padding: 4px; border-radius: 12px; display: flex; gap: 4px; }
    .day-btn {
        border: none; background: transparent; padding: 8px 16px; border-radius: 8px;
        font-family: 'Sarabun'; font-weight: 600; font-size: 0.9rem; color: var(--text-sub);
        cursor: pointer; transition: all 0.2s ease;
    }
    .day-btn.active { background: var(--surface); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    .actions button {
        width: 40px; height: 40px; border-radius: 10px; border: none;
        background: var(--surface); color: var(--text-sub); cursor: pointer;
        transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 1.1rem;
    }
    .actions button:hover { background: var(--primary-light); color: var(--primary); transform: translateY(-1px); }

    /* Layout */
    .main-layout { display: flex; margin-top: var(--header-h); height: calc(100vh - var(--header-h)); }
    
    /* Sidebar */
    .sidebar {
        width: var(--sidebar-w); background: var(--surface); border-right: 1px solid #e5e7eb;
        overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 8px;
    }
    .nav-group-title { font-size: 0.75rem; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin: 16px 0 8px 12px; letter-spacing: 0.5px; }
    
    .nav-item {
        padding: 10px 12px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px;
        color: var(--text-sub); font-weight: 500; transition: 0.2s;
    }
    .nav-item:hover { background: var(--bg); color: var(--primary); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 700; }
    .nav-icon { width: 24px; text-align: center; }

    /* Sub Menu */
    .sub-menu { padding-left: 42px; display: none; flex-direction: column; gap: 2px; }
    .sub-menu.open { display: flex; }
    .sub-item {
        padding: 6px 12px; font-size: 0.85rem; color: #6b7280; cursor: pointer; border-radius: 6px; position: relative;
    }
    .sub-item:hover { color: var(--text-main); background: #f9fafb; }
    .sub-item::before { content: ''; position: absolute; left: -10px; top: 50%; width: 6px; height: 1px; background: #d1d5db; }
    .sub-item.active { color: var(--primary); font-weight: 600; background: var(--primary-light); }

    /* Content Area */
    .content { flex: 1; padding: 24px; overflow-y: auto; scroll-behavior: smooth; }

    /* Welcome Page */
    .welcome-hero {
        text-align: center; margin-top: 60px; animation: fadeIn 0.6s ease;
    }
    .hero-icon { font-size: 4rem; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 4px 6px rgba(37, 99, 235, 0.3)); }
    .hero-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 12px; color: #111827; }
    .hero-desc { font-size: 1.1rem; color: #6b7280; max-width: 600px; margin: 0 auto 40px; line-height: 1.6; }
    .quick-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; max-width: 800px; margin: 0 auto; }
    .quick-card {
        background: var(--surface); padding: 24px; border-radius: 16px; cursor: pointer;
        border: 1px solid #e5e7eb; transition: all 0.2s; text-align: center;
    }
    .quick-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); border-color: var(--primary); }
    .quick-card i { font-size: 2rem; margin-bottom: 12px; display: block; }

    /* Modern Match Card */
    .match-card {
        background: var(--surface); border-radius: var(--radius); padding: 0;
        box-shadow: var(--shadow); border: 1px solid #f3f4f6;
        display: flex; flex-direction: column; transition: transform 0.2s;
        margin-bottom: 16px; overflow: hidden; position: relative;
    }
    .match-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
    
    .card-left-strip { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
    
    .card-body { padding: 16px 20px; display: flex; align-items: center; gap: 20px; }
    
    /* Time & Location */
    .match-meta { display: flex; flex-direction: column; align-items: center; min-width: 80px; text-align: center; border-right: 1px solid #f3f4f6; padding-right: 20px; }
    .time-big { font-family: 'Chakra Petch', sans-serif; font-size: 1.5rem; font-weight: 700; color: #111827; line-height: 1; }
    .field-small { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; font-weight: 500; }
    
    /* Teams & Score */
    .match-main { flex: 1; display: flex; align-items: center; justify-content: space-between; }
    .team-box { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    .team-name { font-size: 1rem; font-weight: 600; color: #374151; }
    .team-name.winner { color: var(--primary); font-weight: 700; }
    .team-placeholder { color: #d1d5db; font-style: italic; }
    .team-right { text-align: right; }

    /* Digital Scoreboard */
    .scoreboard { display: flex; align-items: center; gap: 8px; background: #111827; padding: 6px 12px; border-radius: 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
    .score-input {
        width: 36px; background: transparent; border: none; color: #ef4444; /* LED Red */
        font-family: 'Chakra Petch', monospace; font-size: 1.5rem; font-weight: 700; text-align: center;
    }
    .score-input:last-child { color: #3b82f6; /* LED Blue */ }
    .score-input:focus { outline: none; background: #1f2937; border-radius: 4px; }
    .score-div { color: #4b5563; font-weight: 700; }

    /* Footer / Badge */
    .card-footer {
        background: #f9fafb; padding: 8px 20px; font-size: 0.75rem; color: #6b7280;
        display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f3f4f6;
    }
    .cat-badge { padding: 2px 8px; border-radius: 6px; font-weight: 700; font-size: 0.7rem; color: white; }
    
    /* Right Panel (Table) */
    .right-panel { width: 320px; background: var(--surface); border-left: 1px solid #e5e7eb; padding: 20px; overflow-y: auto; }
    .rp-header { font-weight: 700; color: #111827; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    
    .st-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; margin-bottom: 24px; }
    .st-table th { text-align: left; padding: 8px; color: #6b7280; font-weight: 600; border-bottom: 2px solid #f3f4f6; }
    .st-table td { padding: 8px; border-bottom: 1px solid #f3f4f6; }
    .st-table tr:nth-child(even) { background-color: #f9fafb; } /* Zebra Stripe */
    .st-rank { font-weight: 700; color: #9ca3af; width: 20px; }
    .st-pts { font-weight: 700; color: var(--primary); text-align: center; background: #eff6ff; border-radius: 6px; }

    /* Colors */
    .c-FB { background-color: var(--c-fb); } .text-FB { color: var(--c-fb); }
    .c-VB { background-color: var(--c-vb); } .text-VB { color: var(--c-vb); }
    .c-TK { background-color: var(--c-tk); } .text-TK { color: var(--c-tk); }
    .c-PT { background-color: var(--c-pt); } .text-PT { color: var(--c-pt); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    @media (max-width: 1024px) { .right-panel { display: none; } .sidebar { width: 220px; } }
</style>
</head>
<body>

<header class="app-header">
    <div class="brand" onclick="goHome()">
        <i class="fas fa-medal"></i> NONSAWAN GAMES
    </div>
    
    <div class="day-selector">
        <button class="day-btn active" onclick="setDay(1)">16 ธ.ค.</button>
        <button class="day-btn" onclick="setDay(2)">17 ธ.ค.</button>
        <button class="day-btn" onclick="setDay(3)">18 ธ.ค.</button>
        <button class="day-btn" onclick="setDay(4)">19 ธ.ค.</button>
    </div>

    <div class="actions">
        <button onclick="saveToLocal()" title="บันทึก"><i class="fas fa-save"></i></button>
        <button onclick="resetSystem()" title="รีเซ็ต"><i class="fas fa-redo-alt"></i></button>
    </div>
</header>

<div class="main-layout">
    <aside class="sidebar">
        <div class="nav-item active" onclick="filterSport('WELCOME')">
            <div class="nav-icon"><i class="fas fa-home"></i></div> หน้าแรก
        </div>

        <div class="nav-group-title">แยกตามกีฬา</div>
        
        <div class="nav-item" onclick="toggleSub('sub-fb', 'FB')">
            <div class="nav-icon text-FB"><i class="fas fa-futbol"></i></div> ฟุตบอล
            <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.7rem;"></i>
        </div>
        <div id="sub-fb" class="sub-menu">
            <div class="sub-item" onclick="filterLevel('FB', 'K')">อนุบาล</div>
            <div class="sub-item" onclick="filterLevel('FB', 'P')">ประถม</div>
            <div class="sub-item" onclick="filterLevel('FB', 'S')">มัธยม</div>
        </div>

        <div class="nav-item" onclick="toggleSub('sub-vb', 'VB')">
            <div class="nav-icon text-VB"><i class="fas fa-volleyball-ball"></i></div> วอลเลย์บอล
            <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.7rem;"></i>
        </div>
        <div id="sub-vb" class="sub-menu">
            <div class="sub-item" onclick="filterLevel('VB', 'P')">ประถม</div>
            <div class="sub-item" onclick="filterLevel('VB', 'S')">มัธยม</div>
        </div>

        <div class="nav-item" onclick="toggleSub('sub-tk', 'TK')">
            <div class="nav-icon text-TK"><i class="fas fa-baseball-ball"></i></div> เซปักตะกร้อ
             <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.7rem;"></i>
        </div>
         <div id="sub-tk" class="sub-menu">
            <div class="sub-item" onclick="filterLevel('TK', 'P')">ประถม</div>
            <div class="sub-item" onclick="filterLevel('TK', 'S')">มัธยม</div>
        </div>

        <div class="nav-item" onclick="toggleSub('sub-pt', 'PT')">
            <div class="nav-icon text-PT"><i class="fas fa-bowling-ball"></i></div> เปตอง
             <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.7rem;"></i>
        </div>
        <div id="sub-pt" class="sub-menu">
            <div class="sub-item" onclick="filterLevel('PT', 'P')">ประถม</div>
            <div class="sub-item" onclick="filterLevel('PT', 'S')">มัธยม</div>
        </div>
    </aside>

    <main class="content" id="mainContent">
        </main>

    <aside class="right-panel">
        <div class="rp-header"><i class="fas fa-list-ol"></i> ตารางคะแนน</div>
        <div id="standingsContent"></div>
    </aside>
</div>

<div id="toast" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#111827; color:white; padding:12px 24px; border-radius:50px; opacity:0; pointer-events:none; transition:0.3s;">บันทึกเรียบร้อย ✅</div>

<script>
// --- DATA & CONFIG ---
const schools = [
    { id: 'S1', name: "โนนสวรรค์ฯ", type: 'PRI' }, { id: 'S2', name: "ท่าอุทัย", type: 'PRI' },
    { id: 'S3', name: "ภูพระฯ", type: 'PRI' }, { id: 'S4', name: "โนนม่วง", type: 'PRI' },
    { id: 'S5', name: "โนนสวาทฯ", type: 'PRI' }, { id: 'S6', name: "หนองกุงศรีฯ", type: 'PRI' },
    { id: 'S7', name: "โนนไหมฯ", type: 'PRI' }, { id: 'S8', name: "ด้วงฯ-ชำฯ", type: 'PRI' },
    { id: 'S9', name: "โนนเมือง", type: 'PRI' },
    { id: 'M1', name: "หนองกุงศรีฯ (ม)", type: 'SEC' }, { id: 'M2', name: "ภูพระฯ (ม)", type: 'SEC' },
    { id: 'M3', name: "โนนม่วง (ม)", type: 'SEC' }, { id: 'M4', name: "โนนเมือง (ม)", type: 'SEC' }
];

const categories = [
    // Football
    { id: 'FB_K_M', sp: 'FB', name: 'บอลอนุบาล ชาย', dur: 30, field: 'สนามอนุบาล', lv: 'K', gd: 'M', format: 'group' },
    { id: 'FB_K_F', sp: 'FB', name: 'บอลอนุบาล หญิง', dur: 30, field: 'สนามอนุบาล', lv: 'K', gd: 'F', format: 'group' },
    { id: 'FB_P13_M', sp: 'FB', name: 'บอล ป.ต้น ชาย', dur: 45, field: 'สนาม 1', lv: 'P13', gd: 'M', format: 'group' },
    { id: 'FB_P13_F', sp: 'FB', name: 'บอล ป.ต้น หญิง', dur: 45, field: 'สนาม 1', lv: 'P13', gd: 'F', format: 'group' },
    { id: 'FB_P46_M', sp: 'FB', name: 'บอล ป.ปลาย ชาย', dur: 60, field: 'สนาม 2', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'FB_P46_F', sp: 'FB', name: 'บอล ป.ปลาย หญิง', dur: 60, field: 'สนาม 2', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'FB_SEC_M', sp: 'FB', name: 'บอล มัธยม ชาย', dur: 60, field: 'สนาม 3', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'FB_SEC_F', sp: 'FB', name: 'บอล มัธยม หญิง', dur: 60, field: 'สนาม 3', lv: 'SEC', gd: 'F', format: 'league' },
    // Volleyball
    { id: 'VB_P46_M', sp: 'VB', name: 'วอลเลย์ ป.ปลาย ชาย', dur: 60, field: 'วอลเลย์ 1', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'VB_P46_F', sp: 'VB', name: 'วอลเลย์ ป.ปลาย หญิง', dur: 60, field: 'วอลเลย์ 1', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'VB_SEC_M', sp: 'VB', name: 'วอลเลย์ มัธยม ชาย', dur: 60, field: 'วอลเลย์ 2', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'VB_SEC_F', sp: 'VB', name: 'วอลเลย์ มัธยม หญิง', dur: 60, field: 'วอลเลย์ 2', lv: 'SEC', gd: 'F', format: 'league' },
    // Takraw
    { id: 'TK_P46_M', sp: 'TK', name: 'ตะกร้อ ป.ปลาย ชาย', dur: 45, field: 'สนามตะกร้อ', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'TK_P46_F', sp: 'TK', name: 'ตะกร้อ ป.ปลาย หญิง', dur: 45, field: 'สนามตะกร้อ', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'TK_SEC_M', sp: 'TK', name: 'ตะกร้อ มัธยม ชาย', dur: 45, field: 'สนามตะกร้อ', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'TK_SEC_F', sp: 'TK', name: 'ตะกร้อ มัธยม หญิง', dur: 45, field: 'สนามตะกร้อ', lv: 'SEC', gd: 'F', format: 'league' },
    // Petanque
    { id: 'PT_P46_M', sp: 'PT', name: 'เปตอง ป.ปลาย ชาย', dur: 60, field: 'เปตอง 1', lv: 'P46', gd: 'M', format: 'group' },
    { id: 'PT_P46_F', sp: 'PT', name: 'เปตอง ป.ปลาย หญิง', dur: 60, field: 'เปตอง 1', lv: 'P46', gd: 'F', format: 'group' },
    { id: 'PT_SEC_M', sp: 'PT', name: 'เปตอง มัธยม ชาย', dur: 60, field: 'เปตอง 2', lv: 'SEC', gd: 'M', format: 'league' },
    { id: 'PT_SEC_F', sp: 'PT', name: 'เปตอง มัธยม หญิง', dur: 60, field: 'เปตอง 2', lv: 'SEC', gd: 'F', format: 'league' }
];

const days = [
    { d:1, start: 780, end: 990, label: 'วันที่ 1 (บ่าย)' },
    { d:2, start: 780, end: 990, label: 'วันที่ 2 (บ่าย)' },
    { d:3, start: 510, end: 990, label: 'วันที่ 3 (เต็ม)' },
    { d:4, start: 510, end: 990, label: 'วันที่ 4 (ชิงฯ)' }
];

let scheduleData = [];
let currentDay = 1;
let currentFilter = 'WELCOME';
let currentSubFilter = null; // 'K', 'P', 'S' or null

// --- LOGIC: SAME AS V.42 (Engine preserved) ---
function generateSchedule() {
    let matches = [];
    let priSchools = schools.filter(s => s.type === 'PRI');
    let secSchools = schools.filter(s => s.type === 'SEC');

    categories.forEach(cat => {
        let teams = (cat.lv === 'SEC') ? secSchools : priSchools;
        
        if (cat.format === 'group') {
            let shuffled = [...teams].sort(() => 0.5 - Math.random());
            let groups = { 'A': shuffled.slice(0,3), 'B': shuffled.slice(3,6), 'C': shuffled.slice(6,9) };
            
            ['A','B','C'].forEach(gName => {
                let gTeams = groups[gName];
                gTeams.forEach((t1, i) => {
                    for(let j=i+1; j<gTeams.length; j++) {
                        matches.push({
                            uid: `${cat.id}_G${gName}_${i}${j}`, cat: cat, round: `รอบแรก สาย ${gName}`,
                            t1: t1, t2: gTeams[j], stage: 'GROUP', group: gName, priority: 1
                        });
                    }
                });
            });

            matches.push({ uid: `${cat.id}_SF1`, cat:cat, round:'รอบรองฯ 1', t1:{name:'ที่ 1 สาย A', id:'W_A'}, t2:{name:'ที่ดีสุด', id:'BEST_2'}, stage:'SEMI', priority: 2 });
            matches.push({ uid: `${cat.id}_SF2`, cat:cat, round:'รอบรองฯ 2', t1:{name:'ที่ 1 สาย B', id:'W_B'}, t2:{name:'ที่ 1 สาย C', id:'W_C'}, stage:'SEMI', priority: 2 });
            matches.push({ uid: `${cat.id}_3RD`, cat:cat, round:'ชิงอันดับ 3', t1:{name:'แพ้รอง 1', id:'L_SF1'}, t2:{name:'แพ้รอง 2', id:'L_SF2'}, stage:'FINAL_3RD', priority: 3 });
            matches.push({ uid: `${cat.id}_FN`, cat:cat, round:'ชิงชนะเลิศ', t1:{name:'ชนะรอง 1', id:'W_SF1'}, t2:{name:'ชนะรอง 2', id:'W_SF2'}, stage:'FINAL_1ST', priority: 3 });

        } else {
            teams.forEach((t1, i) => {
                for(let j=i+1; j<teams.length; j++) {
                    matches.push({
                        uid: `${cat.id}_L_${i}${j}`, cat: cat, round: 'พบกันหมด',
                        t1: t1, t2: teams[j], stage: 'LEAGUE', priority: 1
                    });
                }
            });
            matches.push({ uid: `${cat.id}_3RD`, cat:cat, round:'ชิงอันดับ 3', t1:{name:'อันดับ 3', id:'R3'}, t2:{name:'อันดับ 4', id:'R4'}, stage:'FINAL_3RD', priority: 2 });
            matches.push({ uid: `${cat.id}_FN`, cat:cat, round:'ชิงชนะเลิศ', t1:{name:'อันดับ 1', id:'R1'}, t2:{name:'อันดับ 2', id:'R2'}, stage:'FINAL_1ST', priority: 2 });
        }
    });

    matches.sort((a,b) => (a.priority !== b.priority) ? a.priority - b.priority : (a.cat.sp === 'TK' && b.cat.sp !== 'TK' ? -1 : 0));

    let scheduled = [];
    let fieldBusy = {};
    let athleteBusy = {};
    let queue = [...matches];

    const getRef = (day, time, cat, t1, t2) => {
        if(cat.lv === 'K') return "กรรมการกลาง";
        let candidates = (cat.lv === 'SEC') ? secSchools : priSchools;
        candidates = candidates.filter(s => s.id !== t1.id && s.id !== t2.id);
        let valid = candidates.find(s => (athleteBusy[`${s.id}_${cat.lv}_${cat.gd}_${day}`] || 0) <= time);
        return valid ? `ครู ${valid.name}` : "กรรมการกลาง";
    };

    days.forEach(dayConf => {
        let nextQueue = [];
        categories.forEach(c => { if(!fieldBusy[`${c.field}_${dayConf.d}`]) fieldBusy[`${c.field}_${dayConf.d}`] = dayConf.start; });

        if (dayConf.d === 4) {
             categories.forEach(c => { fieldBusy[`${c.field}_4`] = 510; });
        }

        queue.forEach(m => {
            if (dayConf.d === 4) {
                if (m.stage !== 'FINAL_3RD' && m.stage !== 'FINAL_1ST') { nextQueue.push(m); return; }
                if (m.stage === 'FINAL_1ST') {
                    let fKey = `${m.cat.field}_4`;
                    if (fieldBusy[fKey] < 780) fieldBusy[fKey] = 780; 
                }
            } else {
                if (m.stage === 'FINAL_3RD' || m.stage === 'FINAL_1ST') { nextQueue.push(m); return; }
            }

            let maxTime = (m.cat.lv === 'K') ? 930 : dayConf.end;
            let fieldKey = `${m.cat.field}_${dayConf.d}`;
            let fieldStart = fieldBusy[fieldKey];

            let t1Key = (m.t1.id.startsWith('W') || m.t1.id.startsWith('L') || m.t1.id.startsWith('R')) ? null : `${m.t1.id}_${m.cat.lv}_${m.cat.gd}_${dayConf.d}`;
            let t2Key = (m.t2.id.startsWith('W') || m.t2.id.startsWith('L') || m.t2.id.startsWith('R')) ? null : `${m.t2.id}_${m.cat.lv}_${m.cat.gd}_${dayConf.d}`;
            
            let startTime = Math.max(fieldStart, t1Key ? (athleteBusy[t1Key]||dayConf.start) : dayConf.start, t2Key ? (athleteBusy[t2Key]||dayConf.start) : dayConf.start);
            let endTime = startTime + m.cat.dur;

            if (endTime <= maxTime) {
                let ref = getRef(dayConf.d, startTime, m.cat, m.t1, m.t2);
                scheduled.push({ ...m, day: dayConf.d, timeStart: startTime, timeEnd: endTime, s1: '', s2: '', referee: ref });
                fieldBusy[fieldKey] = endTime;
                let gap = m.cat.dur;
                if(t1Key) athleteBusy[t1Key] = endTime + gap;
                if(t2Key) athleteBusy[t2Key] = endTime + gap;
            } else {
                nextQueue.push(m);
            }
        });
        queue = nextQueue;
    });
    return scheduled;
}

function resolveTeamNames() {
    let stats = {};
    categories.forEach(cat => {
        stats[cat.id] = {};
        let matches = scheduleData.filter(m => m.cat.id === cat.id && (m.stage === 'GROUP' || m.stage === 'LEAGUE') && m.s1 !== '' && m.s2 !== '');
        matches.forEach(m => {
            if(!stats[cat.id][m.t1.id]) stats[cat.id][m.t1.id] = { id:m.t1.id, name:m.t1.name, PTS:0, G:m.group };
            if(!stats[cat.id][m.t2.id]) stats[cat.id][m.t2.id] = { id:m.t2.id, name:m.t2.name, PTS:0, G:m.group };
            let s1 = parseInt(m.s1), s2 = parseInt(m.s2);
            if(s1 > s2) stats[cat.id][m.t1.id].PTS += 3;
            else if(s2 > s1) stats[cat.id][m.t2.id].PTS += 3;
            else { stats[cat.id][m.t1.id].PTS += 1; stats[cat.id][m.t2.id].PTS += 1; }
        });
    });

    scheduleData.forEach(m => {
        if(m.stage.includes('SEMI') || m.stage.includes('FINAL')) {
            m.t1 = resolvePlaceholder(m.t1, m.cat.id, stats);
            m.t2 = resolvePlaceholder(m.t2, m.cat.id, stats);
        }
    });
}

function resolvePlaceholder(teamObj, catId, stats) {
    if(!['W_','L_','R','BEST'].some(k => teamObj.id.startsWith(k))) return teamObj;
    let catStats = Object.values(stats[catId] || {});
    const getSorted = (group) => catStats.filter(t => t.G === group).sort((a,b) => b.PTS - a.PTS);

    if(teamObj.id === 'W_A') { let t = getSorted('A')[0]; if(t) return {name: t.name, id: t.id, isResolved:true}; }
    if(teamObj.id === 'W_B') { let t = getSorted('B')[0]; if(t) return {name: t.name, id: t.id, isResolved:true}; }
    if(teamObj.id === 'W_C') { let t = getSorted('C')[0]; if(t) return {name: t.name, id: t.id, isResolved:true}; }
    if(teamObj.id === 'BEST_2') {
        let secs = []; ['A','B','C'].forEach(g => { let s=getSorted(g)[1]; if(s) secs.push(s); });
        secs.sort((a,b) => b.PTS - a.PTS); if(secs[0]) return {name: secs[0].name, id: secs[0].id, isResolved:true};
    }
    if(teamObj.id.startsWith('R')) {
        let r = parseInt(teamObj.id.replace('R','')) - 1;
        let s = catStats.sort((a,b) => b.PTS - a.PTS); if(s[r]) return {name: s[r].name, id: s[r].id, isResolved:true};
    }
    if(teamObj.id.includes('SF')) {
        let ref = teamObj.id.replace(/[WL]_/,''); 
        let prev = scheduleData.find(m => m.uid.includes(ref));
        if(prev && prev.s1 && prev.s2) {
            let win = parseInt(prev.s1)>parseInt(prev.s2);
            let target = teamObj.id.startsWith('W_') ? (win?prev.t1:prev.t2) : (win?prev.t2:prev.t1);
            return {name: target.name, id: target.id, isResolved:true};
        }
    }
    return teamObj;
}

// --- UI LOGIC ---

function goHome() {
    currentFilter = 'WELCOME';
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelector('.nav-item').classList.add('active'); // Welcome btn
    renderWelcome();
    renderStandings(); // Clear or show empty
}

function toggleSub(id, sport) {
    // 1. Set Active Main
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    // 2. Toggle Submenu
    let el = document.getElementById(id);
    let isOpen = el.classList.contains('open');
    document.querySelectorAll('.sub-menu').forEach(s => s.classList.remove('open')); // Close others
    if(!isOpen) el.classList.add('open');
    
    // 3. Filter All of this Sport
    filterSport(sport);
}

function filterSport(sp) {
    currentFilter = sp;
    currentSubFilter = null; // Reset sub
    document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active'));
    if(sp === 'WELCOME') renderWelcome();
    else renderSchedule();
    renderStandings();
}

function filterLevel(sp, lv) {
    event.stopPropagation(); // Stop bubbling to toggleSub
    currentFilter = sp;
    currentSubFilter = lv;
    
    document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
    
    renderSchedule();
    renderStandings();
}

function setDay(d) {
    currentDay = d;
    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    if(currentFilter !== 'WELCOME') renderSchedule();
}

function formatTime(min) {
    let h = Math.floor(min/60);
    let m = min%60;
    return `${h.toString().padStart(2,'0')}.${m.toString().padStart(2,'0')}`;
}

function renderWelcome() {
    const c = document.getElementById('mainContent');
    c.innerHTML = `
    <div class="welcome-hero">
        <i class="fas fa-trophy hero-icon"></i>
        <div class="hero-title">ยินดีต้อนรับสู่ระบบจัดการแข่งขัน</div>
        <div class="hero-desc">ระบบบริหารจัดการตารางเวลาและผลการแข่งขันกีฬาสี<br>เวอร์ชั่น 45 (Modern UI)</div>
        <div class="quick-grid">
            <div class="quick-card text-FB" onclick="toggleSub('sub-fb', 'FB')"><i class="fas fa-futbol"></i>ฟุตบอล</div>
            <div class="quick-card text-VB" onclick="toggleSub('sub-vb', 'VB')"><i class="fas fa-volleyball-ball"></i>วอลเลย์บอล</div>
            <div class="quick-card text-TK" onclick="toggleSub('sub-tk', 'TK')"><i class="fas fa-baseball-ball"></i>ตะกร้อ</div>
            <div class="quick-card text-PT" onclick="toggleSub('sub-pt', 'PT')"><i class="fas fa-bowling-ball"></i>เปตอง</div>
        </div>
    </div>`;
}

function renderSchedule() {
    resolveTeamNames();
    const c = document.getElementById('mainContent');
    c.innerHTML = '';
    
    let list = scheduleData.filter(m => m.day === currentDay);
    
    // Filter Logic
    if(currentFilter !== 'ALL') {
        list = list.filter(m => m.cat.sp === currentFilter);
        if(currentSubFilter) {
            // Map subfilter 'P' to P13/P46, 'S' to SEC, 'K' to K
            if(currentSubFilter === 'P') list = list.filter(m => m.cat.lv.startsWith('P'));
            else if(currentSubFilter === 'S') list = list.filter(m => m.cat.lv === 'SEC');
            else if(currentSubFilter === 'K') list = list.filter(m => m.cat.lv === 'K');
        }
    }
    
    list.sort((a,b) => a.timeStart - b.timeStart);

    if(list.length === 0) {
        c.innerHTML = `<div style="text-align:center; padding:60px; color:#9ca3af;"><i class="far fa-calendar-times" style="font-size:3rem; margin-bottom:10px;"></i><br>ไม่มีการแข่งขันในหมวดหมู่นี้</div>`;
        return;
    }

    list.forEach(m => {
        let t1Class = m.t1.isResolved ? 'team-name winner' : (m.t1.name.includes('ที่') ? 'team-name team-placeholder' : 'team-name');
        let t2Class = m.t2.isResolved ? 'team-name winner' : (m.t2.name.includes('ที่') ? 'team-name team-placeholder' : 'team-name');
        
        let html = `
        <div class="match-card">
            <div class="card-left-strip c-${m.cat.sp}"></div>
            <div class="card-body">
                <div class="match-meta">
                    <div class="time-big">${formatTime(m.timeStart)}</div>
                    <div class="field-small">${m.cat.field}</div>
                </div>
                
                <div class="match-main">
                    <div class="team-box">
                        <div class="team-name ${t1Class}">${m.t1.name}</div>
                    </div>
                    
                    <div class="scoreboard">
                        <input type="number" class="score-input" value="${m.s1}" onchange="upd('${m.uid}',1,this.value)">
                        <span class="score-div">:</span>
                        <input type="number" class="score-input" value="${m.s2}" onchange="upd('${m.uid}',2,this.value)">
                    </div>
                    
                    <div class="team-box team-right">
                        <div class="team-name ${t2Class}">${m.t2.name}</div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <span class="cat-badge c-${m.cat.sp}">${m.cat.name}</span>
                <span>${m.round}</span>
                <span><i class="fas fa-whistle"></i> ${m.referee}</span>
            </div>
        </div>`;
        c.innerHTML += html;
    });
}

function renderStandings() {
    const c = document.getElementById('standingsContent');
    c.innerHTML = '';
    
    if(currentFilter === 'WELCOME') {
        c.innerHTML = `<div style="text-align:center; color:#9ca3af; margin-top:40px;">เลือกกีฬาเพื่อดูคะแนน</div>`;
        return;
    }

    // Determine categories to show based on filter
    let targets = categories.filter(cat => {
        if(cat.sp !== currentFilter) return false;
        if(currentSubFilter) {
            if(currentSubFilter === 'P' && !cat.lv.startsWith('P')) return false;
            if(currentSubFilter === 'S' && cat.lv !== 'SEC') return false;
            if(currentSubFilter === 'K' && cat.lv !== 'K') return false;
        }
        return true;
    });

    targets.forEach(cat => {
        // Calc Stats
        let matches = scheduleData.filter(m => m.cat.id === cat.id && (m.stage === 'GROUP' || m.stage === 'LEAGUE') && m.s1 && m.s2);
        let teams = {};
        matches.forEach(m => {
            if(!teams[m.t1.name]) teams[m.t1.name] = {P:0,PTS:0,G:m.group};
            if(!teams[m.t2.name]) teams[m.t2.name] = {P:0,PTS:0,G:m.group};
            let s1=parseInt(m.s1), s2=parseInt(m.s2);
            teams[m.t1.name].P++; teams[m.t2.name].P++;
            if(s1>s2) teams[m.t1.name].PTS+=3;
            else if(s2>s1) teams[m.t2.name].PTS+=3;
            else { teams[m.t1.name].PTS++; teams[m.t2.name].PTS++; }
        });

        let html = ``;
        if(cat.format === 'group') {
            ['A','B','C'].forEach(g => {
                let list = Object.keys(teams).filter(t=>teams[t].G===g).sort((a,b)=>teams[b].PTS-teams[a].PTS);
                if(list.length){
                    html += `<div style="padding:4px 0; font-size:0.75rem; font-weight:700; color:#6b7280;">สาย ${g}</div>
                    <table class="st-table">
                        <tr><th class="st-rank">#</th><th>ทีม</th><th class="st-rank">P</th><th>Pts</th></tr>
                        ${list.map((t,i)=>`<tr><td class="st-rank">${i+1}</td><td>${t}</td><td class="st-rank">${teams[t].P}</td><td class="st-pts">${teams[t].PTS}</td></tr>`).join('')}
                    </table>`;
                }
            });
        } else {
            let list = Object.keys(teams).sort((a,b)=>teams[b].PTS-teams[a].PTS);
             if(list.length){
                html += `<table class="st-table">
                    <tr><th class="st-rank">#</th><th>ทีม</th><th class="st-rank">P</th><th>Pts</th></tr>
                    ${list.map((t,i)=>`<tr><td class="st-rank">${i+1}</td><td>${t}</td><td class="st-rank">${teams[t].P}</td><td class="st-pts">${teams[t].PTS}</td></tr>`).join('')}
                </table>`;
            }
        }

        if(html) {
            let div = document.createElement('div');
            div.innerHTML = `<div style="font-weight:700; font-size:0.9rem; margin-bottom:8px; color:var(--text-main);">${cat.name}</div>${html}`;
            c.appendChild(div);
        }
    });
}

function upd(uid, s, v) {
    let m = scheduleData.find(x=>x.uid===uid);
    if(m) {
        if(s===1) m.s1=v; else m.s2=v;
        saveToLocal(true);
        renderSchedule(); renderStandings();
    }
}
function saveToLocal(silent) {
    localStorage.setItem('ns_games_v45', JSON.stringify(scheduleData));
    if(!silent) { let t=document.getElementById('toast'); t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2000); }
}
function resetSystem() { if(confirm('รีเซ็ตข้อมูลใหม่ทั้งหมด?')) { scheduleData=generateSchedule(); saveToLocal(); location.reload(); } }

window.onload = () => {
    let s = localStorage.getItem('ns_games_v45');
    if(s) scheduleData = JSON.parse(s); else scheduleData = generateSchedule();
    renderWelcome();
};
</script>
</body>
</html>
